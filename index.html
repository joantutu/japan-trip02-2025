<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>ÈóúÊù±Êñ∞Êò•Ëá™ÈßïÈÅä 2026 (V40 ÂÑ™ÂåñÁâà) üéå</title>
<script src="https://cdn.tailwindcss.com"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<style>
    body{touch-action:manipulation;background-color:#fff7ed;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;-webkit-tap-highlight-color:transparent;overscroll-behavior-y:none;-webkit-user-select:none;user-select:none;}
    input,textarea{-webkit-user-select:auto;user-select:auto;font-size:16px!important}
    .hide-scrollbar::-webkit-scrollbar{display:none}.hide-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
    .scroll-smooth-mobile{-webkit-overflow-scrolling:touch;scroll-behavior:smooth}
    .pb-safe{padding-bottom:env(safe-area-inset-bottom,24px)}.pt-safe{padding-top:env(safe-area-inset-top,0px)}
    .card-shadow{box-shadow:0 2px 10px -1px rgba(0,0,0,0.05)}
    .font-rounded{font-weight:800;letter-spacing:0.03em;}
    .drag-handle, .drag-handle-memo { cursor: grab; touch-action: none !important; user-select: none; -webkit-user-select: none; }
    .drag-handle:active, .drag-handle-memo:active { cursor: grabbing; }
    .sortable-ghost { opacity: 0.4; background-color: #fef9c3; border: 2px dashed #fcd34d; }
    .sortable-drag { opacity: 1; background: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); transform: scale(1.02); z-index: 100; }
    .weather-spin { animation: spin-slow 10s linear infinite; }
    .weather-float { animation: float 3s ease-in-out infinite; }
    .weather-pulse { animation: pulse-soft 2s infinite; }
    @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-3px); } }
    @keyframes pulse-soft { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
    .sakura-btn-container { position: relative; width: 54px; height: 54px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin: 0 4px; overflow: visible; }
    .sakura-icon-active { transform-origin: center center; filter: drop-shadow(0 4px 6px rgba(244, 63, 94, 0.5)); animation: pop-bloom 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards, spin-sakura 12s linear infinite 0.6s; }
    @keyframes pop-bloom { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 60% { transform: scale(1.35) rotate(10deg); opacity: 1; } 100% { transform: scale(1.25) rotate(0deg); opacity: 1; } }
    @keyframes spin-sakura { from { transform: scale(1.25) rotate(0deg); } to { transform: scale(1.25) rotate(360deg); } }
    .sakura-icon-inactive { transform: scale(0.9); opacity: 0.6; transition: all 0.3s ease; }
    .sakura-text-active { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #FEF08A !important; font-size: 16px; font-weight: 900; text-shadow: 0 2px 2px rgba(0,0,0,0.2); z-index: 50; pointer-events: none; }
    .sakura-text-inactive { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: 700; z-index: 50; pointer-events: none; }
    .note-expand { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out, margin 0.3s ease; max-height: 0; opacity: 0; overflow: hidden; }
    .note-expand.open { max-height: 500px; opacity: 1; margin-bottom: 12px; }
    .sort-mode-bg { background-image: radial-gradient(#e5e7eb 1px, transparent 1px); background-size: 20px 20px; }
    .memo-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 8px; }
    .no-scale-anim { transform: none !important; transition: none !important; }
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useRef,useCallback}=React;
const Icons={
    MapPin:<g><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0Z" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="10" r="3"/></g>,
    Plus:<path d="M12 5v14M5 12h14" strokeLinecap="round" strokeLinejoin="round"/>,
    X:<path d="M18 6 6 18M6 6l12 12" strokeLinecap="round" strokeLinejoin="round"/>,
    Save:<path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" strokeLinecap="round" strokeLinejoin="round"/>,
    DollarSign:<path d="M12 1v22M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" strokeLinecap="round" strokeLinejoin="round"/>,
    Utensils:<path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2M7 2v20M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7" strokeLinecap="round" strokeLinejoin="round"/>,
    ShoppingBag:<path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" strokeLinecap="round" strokeLinejoin="round"/>,
    Camera:<g><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" strokeLinecap="round" strokeLinejoin="round"/><circle cx="12" cy="13" r="4"/></g>,
    Bed:<path d="M2 4v16M2 8h18a2 2 0 0 1 2 2v10M2 17h20M6 8v9" strokeLinecap="round" strokeLinejoin="round"/>,
    Car:<g><path d="M14 16H9m10 0h3v-3.15a1 1 0 0 0-.84-.99L16 11l-2.7-3.6a1 1 0 0 0-.8-.4H5.24a2 2 0 0 0-1.8 1.1l-.8 1.63A6 6 0 0 0 2 12.42V16h2" strokeLinecap="round" strokeLinejoin="round"/><circle cx="6.5" cy="16.5" r="2.5"/><circle cx="16.5" cy="16.5" r="2.5"/></g>,
    MoreVertical:<g><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></g>,
    Sun:<g><circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" strokeLinecap="round" strokeLinejoin="round"/></g>,
    Cloud:<g><path d="M17.5 19C19.9853 19 22 16.9853 22 14.5C22 12.132 20.177 10.244 17.812 10.035C17.406 6.89 14.762 4.5 11.5 4.5C8.238 4.5 5.594 6.89 5.188 10.035C2.823 10.244 1 12.132 1 14.5C1 16.9853 3.0147 19 5.5 19H17.5Z" strokeWidth="2" stroke="currentColor" fill="none" strokeLinecap="round" strokeLinejoin="round"/></g>,
    CloudSnow:<g><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25" strokeLinecap="round" strokeLinejoin="round"/><line x1="8" y1="16" x2="8.01" y2="16" strokeWidth="3" strokeLinecap="round"/><line x1="8" y1="20" x2="8.01" y2="20" strokeWidth="3" strokeLinecap="round"/><line x1="12" y1="18" x2="12.01" y2="18" strokeWidth="3" strokeLinecap="round"/><line x1="12" y1="22" x2="12.01" y2="22" strokeWidth="3" strokeLinecap="round"/><line x1="16" y1="16" x2="16.01" y2="16" strokeWidth="3" strokeLinecap="round"/><line x1="16" y1="20" x2="16.01" y2="20" strokeWidth="3" strokeLinecap="round"/></g>,
    CloudRain:<g><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25" strokeLinecap="round" strokeLinejoin="round"/><line x1="8" y1="16" x2="8" y2="16" strokeWidth="3" strokeLinecap="round"/><line x1="8" y1="20" x2="8" y2="20" strokeWidth="3" strokeLinecap="round"/><line x1="16" y1="16" x2="16" y2="16" strokeWidth="3" strokeLinecap="round"/><line x1="16" y1="20" x2="16" y2="20" strokeWidth="3" strokeLinecap="round"/><line x1="12" y1="18" x2="12" y2="18" strokeWidth="3" strokeLinecap="round"/><line x1="12" y1="22" x2="12" y2="22" strokeWidth="3" strokeLinecap="round"/></g>,
    Menu:<path d="M4 6h16M4 12h16M4 18h16" strokeLinecap="round" strokeLinejoin="round"/>,
    Trash2:<path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" strokeLinecap="round" strokeLinejoin="round"/>,
    ChevronUp:<path d="m18 15-6-6-6 6" strokeLinecap="round" strokeLinejoin="round"/>,
    CheckCircle2:<g><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4" strokeLinecap="round" strokeLinejoin="round"/></g>,
    Circle:<circle cx="12" cy="12" r="10"/>,
    Footprints:<g><path d="M12 14c-3 0-5 2-5 4.5S9.5 22 12 22s5-3.5 5-4.5-2-4.5-5-4.5z" fill="#F472B6"/><ellipse cx="6" cy="9" rx="2" ry="2.5" fill="#F472B6"/><ellipse cx="10" cy="7" rx="2" ry="2.5" fill="#F472B6"/><ellipse cx="14" cy="7" rx="2" ry="2.5" fill="#F472B6"/><ellipse cx="18" cy="9" rx="2" ry="2.5" fill="#F472B6"/></g>,
    ArrowDown:<path d="M12 5v14M19 12l-7 7-7-7" strokeLinecap="round" strokeLinejoin="round"/>,
    Search:<g><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3" strokeLinecap="round" strokeLinejoin="round"/></g>,
    Check:<polyline points="20 6 9 17 4 12" strokeLinecap="round" strokeLinejoin="round"/>,
    Clock:<g><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14" strokeLinecap="round" strokeLinejoin="round"/></g>,
    Download:<g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></g>,
    Upload:<g><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></g>,
    Link:<path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" strokeLinecap="round" strokeLinejoin="round"/>,
    ExternalLink:<path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6m4-3h6v6m-11 5L21 3" strokeLinecap="round" strokeLinejoin="round"/>,
    Navigation:<path d="M3 11l19-9-9 19-2-8-8-2z" strokeLinecap="round" strokeLinejoin="round"/>,
    Route:<g><circle cx="6" cy="19" r="3"/><path d="M9 19h8.5a3.5 3.5 0 0 0 0-7h-11a3.5 3.5 0 0 1 0-7H15"/><circle cx="18" cy="5" r="3"/></g>,
    Globe:<g><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></g>,
    Book:<g><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></g>,
    Edit:<g><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></g>,
    Fire:<g><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-5-6.33-5-6.33S1 10.62 1 12a2.5 2.5 0 0 0 2.5 2.5 2.5 2.5 0 0 0 2.5-2.5 2.5 2.5 0 0 0 2.5 2.5z" fill="#F472B6"/><path d="M15.5 17.5a3.5 3.5 0 0 0 5-5c0-1.93-7-8.86-7-8.86s-7 6.93-7 8.86a3.5 3.5 0 0 0 5 5 3.5 3.5 0 0 0 4-3.5 3.5 3.5 0 0 0 3.5 3.5z" fill="#F472B6"/></g>,
    Wallet:<g><rect width="20" height="14" x="2" y="6" rx="2" strokeLinecap="round" strokeLinejoin="round"/><line x1="2" x2="22" y1="10" y2="10" strokeLinecap="round" strokeLinejoin="round"/><line x1="2" x2="22" y1="14" y2="14" strokeLinecap="round" strokeLinejoin="round"/></g>,
    Image:<g><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></g>,
    ChevronLeft:<path d="m15 18-6-6 6-6" strokeLinecap="round" strokeLinejoin="round"/>,
    ChevronRight:<path d="m9 18 6-6-6-6" strokeLinecap="round" strokeLinejoin="round"/>,
    Sort:<g><path d="M3 6h18"/><path d="M7 12h10"/><path d="M10 18h4"/></g>,
    DragHandle:<g><line x1="4" y1="9" x2="20" y2="9" strokeWidth="2.5" strokeLinecap="round"/><line x1="4" y1="15" x2="20" y2="15" strokeWidth="2.5" strokeLinecap="round"/></g>,
    Snowflake:<g><line x1="12" y1="3" x2="12" y2="21" strokeWidth="2"/><line x1="4.2" y1="7.5" x2="19.8" y2="16.5" strokeWidth="2"/><line x1="4.2" y1="16.5" x2="19.8" y2="7.5" strokeWidth="2"/><path d="M8 3.5 12 8 16 3.5" strokeWidth="1.5" fill="none"/><path d="M8 20.5 12 16 16 20.5" strokeWidth="1.5" fill="none"/><path d="M2.5 11 7 12 2.5 13" strokeWidth="1.5" fill="none"/><path d="M21.5 11 17 12 21.5 13" strokeWidth="1.5" fill="none"/></g>,
    Sakura:<g><ellipse cx="12" cy="5" rx="4" ry="6" transform="rotate(0 12 12)" fill="currentColor"/><ellipse cx="12" cy="5" rx="4" ry="6" transform="rotate(72 12 12)" fill="currentColor"/><ellipse cx="12" cy="5" rx="4" ry="6" transform="rotate(144 12 12)" fill="currentColor"/><ellipse cx="12" cy="5" rx="4" ry="6" transform="rotate(216 12 12)" fill="currentColor"/><ellipse cx="12" cy="5" rx="4" ry="6" transform="rotate(288 12 12)" fill="currentColor"/><circle cx="12" cy="12" r="5.5" fill="currentColor"/></g>,
    Map: <path d="M14.1 16.1l-2.4 2.4-2.4-2.4a5 5 0 0 1 4.8 0zM12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7z" strokeLinecap="round" strokeLinejoin="round"/>,
    Maximize: <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7" strokeLinecap="round" strokeLinejoin="round"/>,
    Minimize: <path d="M4 14h6v6M20 10h-6V4M14 10l7-7M10 14l-7 7" strokeLinecap="round" strokeLinejoin="round"/>,
    StickyNote: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></g>,
    Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>
};
const Icon=({n,s=24,c=""})=>Icons[n]?<svg xmlns="http://www.w3.org/2000/svg" width={s} height={s} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={c} overflow="visible">{Icons[n]}</svg>:null;
const CATS={
    sightseeing:{l:'ÊôØÈªû',i:'Camera',c:'bg-rose-100 text-rose-600'},
    food:{l:'ÁæéÈ£ü',i:'Utensils',c:'bg-orange-100 text-orange-600'},
    shopping:{l:'Ë≥ºÁâ©',i:'ShoppingBag',c:'bg-pink-100 text-pink-600'},
    transport:{l:'‰∫§ÈÄö',i:'Car',c:'bg-slate-100 text-slate-600'},
    accommodation:{l:'‰ΩèÂÆø',i:'Bed',c:'bg-indigo-100 text-indigo-600'},
    other:{l:'ÂΩàÊÄß',i:'MoreVertical',c:'bg-emerald-100 text-emerald-600'},
    memo:{l:'‰æøÊ¢ù',i:'StickyNote',c:'bg-yellow-100 text-yellow-600'}
};
const W_ICONS={sunny:'Sun',cloudy:'Cloud',snow:'Snowflake',rain:'CloudRain'};
const WEATHER_COLORS = { sunny: 'text-yellow-300', cloudy: 'text-white/80', rain: 'text-blue-300', snow: 'text-white' };
const WEATHER_LOCATIONS = { 'day1': '327-0102', 'day2': '321-2611', 'day3': '321-2601', 'day4': '311-1301', 'day5': '300-4352', 'day6': '110-0005', 'day7': '282-0004' };
const LOCATIONS_COORD = [
    { id: 'day1', lat: 36.3146, lng: 139.5797 }, 
    { id: 'day2', lat: 36.7490, lng: 139.5033 }, 
    { id: 'day3', lat: 36.7959, lng: 139.4337 }, 
    { id: 'day4', lat: 36.3144, lng: 140.5743 }, 
    { id: 'day5', lat: 36.2048, lng: 140.1067 }, 
    { id: 'day6', lat: 35.7140, lng: 139.7741 }, 
    { id: 'day7', lat: 35.7767, lng: 140.3188 }  
];
const fmtMoney=(v)=>v.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",");
const Linkify = ({ text }) => {
    if (!text) return null;
    const parts = text.split(/(https?:\/\/[^\s]+)/g);
    return parts.map((part, i) => {
        if (part.match(/^https?:\/\//)) {
            return <a key={i} href={part} target="_blank" rel="noopener noreferrer" className="text-blue-500 underline break-all font-bold" onClick={(e)=>e.stopPropagation()}>{part}</a>;
        }
        return part;
    });
};
const getWeatherTypeFromCode = (code) => {
    if (code === undefined || code === null) return 'sunny';
    if (code <= 1) return 'sunny'; 
    if (code <= 3 || code === 45 || code === 48) return 'cloudy';
    if (code >= 71 && code <= 77 || code >= 85) return 'snow'; 
    return 'rain'; 
};
const INITIAL_ITINERARY = [
    {id:'day1',date:'12/28',dayOfWeek:'(Êó•)',weather:'sunny',location:'ÊàêÁî∞ -> ‰ΩêÈáé',steps:0,items:[
        {id:'d1-01',time:'11:25',title:'Âêâ ÊäµÈÅî (BR108)',category:'transport',expenses:[{id:'1',label:'Ê©üÁ•®',amount:0,currency:'NT',category:'transport'}],note:'11:25 Âêâ BR108 NRT T1',mapcode:'',searchKeyword:'',completed:false,steps:500,type:'normal'},
        {id:'d1-02',time:'12:00',title:'ÁéãÊñπ ÊäµÈÅî (BR184)',category:'transport',expenses:[],note:'12:00 ÁéãÊñπ BR184 NRT T1',mapcode:'',searchKeyword:'',completed:false,steps:0,type:'normal'},
        {
          "id": "d1-1",
          "time": "13:00",
          "title": "ÊàêÁî∞Ê©üÂ†¥ÔºöÂèñËªäÂá∫Áôº",
          "category": "transport",
          "note": "Â∫ßÈßïÔºöToyota Estima 4WD (Sakura Rent A Car)\nüöô ÂÇôË®ªÔºöÂ∑≤È†êÁ¥ÑÈõ™ËÉé (Snow Tires)\nÂ∞éËà™Ë®≠ÂÆöÔºöË´ãÂ∑•‰Ωú‰∫∫Âì°Ë®≠ÂÆö„ÄåÈõªË©±ËôüÁ¢ºÊêúÂ∞ã„ÄçÊ®°Âºè„ÄÇ\nÁõÆÊ®ôÔºöÁõ¥Â•î‰ΩêÈáé (ËªäÁ®ãÁ¥Ñ 1.5 ~ 2 Â∞èÊôÇ)„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "e1", "label": "ÁßüËªäË≤ª", "amount": 25446, "currency": "NT", "category": "transport" }
          ],
          "steps": 2000
        },
        {
          "id": "d1-2",
          "time": "14:00",
          "title": "‰∏≠ÈÄî‰ºëÊÅØÔºöÁæΩÁîü PA (‰∏ãË°å)",
          "category": "food",
          "note": "Âú∞ÈªûÔºöPasar ÁæΩÁîü (‰∏ã„Çä) ‚ÄªÊ≥®ÊÑè‰∏çË¶ÅË∑ëÂà∞Â∞çÂêëÁöÑÈ¨ºÂπ≥Ê±üÊà∂Ëôï„ÄÇ\n‰ªªÂãôÔºö\n1. ‰∏äÂªÅÊâÄ (ÈÄôË£°Ë®≠ÊñΩÂæàÊñ∞Âèà‰πæÊ∑®)„ÄÇ\n2. Ë≤∑„ÄåMini One„ÄçÂèØÈ†å Êàñ ÊòüÂ∑¥ÂÖã (Ëªä‰∏äËß£È•ûÁî®)„ÄÇ\nÂÅúÁïôÊôÇÈñìÔºöÁ¥Ñ 20 ÂàÜÈêò„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "ÈªûÂøÉÈ£≤Êñô", "amount": 1500, "currency": "JPY", "category": "food" }
          ],
          "steps": 500
        },
        {
          "id": "d1-3",
          "time": "15:00",
          "title": "Á¨¨‰∏ÄÁ´ôÔºö‰ΩêÈáéÊãâÈ∫µ „Åä„Åê„ÇâÂ±ã",
          "category": "food",
          "searchKeyword": "‰ΩêÈáéÊãâÈ∫µ „Åä„Åê„ÇâÂ±ã",
          "mapcode": "",
          "note": "„ÄêÈ¶ñÈÅ∏„ÄëOguraya\n‰ΩçÁΩÆÔºöÂ∞±Âú®È£ØÂ∫óÈöîÂ£Å (‰ΩêÈáéÂåóÈÉ®)„ÄÇ\nÈõªË©±Ôºö0283-25-1128\nÊîªÁï•ÔºöÂÅúËªäÂ†¥Ë∂ÖÂ§ß„ÄÇÈÄ≤ÂéªÁõ¥Êé•Èªû„Äå„É©„Éº„É°„É≥ (ÊãâÈ∫µ) + È§ÉÂ≠ê (Â§ßÈ°Ü)„Äç„ÄÇÂè™Êî∂ÁèæÈáë„ÄÇ\n\n„ÄêÂÇôÊ°à„ÄëÊãâÈ∫µ Â§™‰∏É (0283-21-8448)ÔºöÈõ¢È£ØÂ∫ó15ÂàÜÔºåÊé®Ëñ¶„ÄåÈùíËî•ÊãâÈ∫µ„Äç+„ÄåÁÉ§ÂÖßËáü„Äç„ÄÇ",
          "expenses": [
            { "id": "e1", "label": "È†ê‰º∞È§êË≤ª", "amount": 3000, "currency": "JPY", "category": "food" }
          ],
          "completed": false,
          "type": "normal",
          "steps": 200
        },
        {
          "id": "d1-4",
          "time": "16:00",
          "title": "Á¨¨‰∫åÁ´ôÔºöÁ£ØÂ±±ÂºÅË≤°Â§©",
          "category": "sightseeing",
          "searchKeyword": "Á£ØÂ±±ÂºÅË≤°Â§©",
          "mapcode": "64 695 571*64",
          "note": "Mapcode: 64 695 571*64\nÈóúÈçµÔºöCheck-in ÂâçÂÖàÂéªÈÄõÔºÅ(16:30 Êó•ËêΩÔºåË¶ÅË∂ÅÊúâÂÖâÁ∑ö)„ÄÇ\nÂÅúËªäÔºöÁõ¥Êé•ÂÅúÈ£ØÂ∫óÂÅúËªäÂ†¥ÔºåÁî®Ëµ∞ÁöÑÈÅéÂéª„ÄÇ\nÂøÖÁúãÈáçÈªûÔºö\n1. Âá∫ÊµÅÂéüÂºÅÂ§©Ê±† (ÂêçÊ∞¥ÁôæÈÅ∏ÔºåÊ∞¥Ë≥™Ê∏ÖÊæà)„ÄÇ\n2. È¢®Á©¥ (Â≤©Áü≥Ê¥ûÂè£)„ÄÇ\n3. ÁôΩËõáÂÉè (Ê±ÇË≤°)„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 1500
        },
        {
          "id": "d1-5",
          "time": "16:40",
          "title": "È£ØÂ∫ó Check-in (‰∏Ä‰πÉÈ§®)",
          "category": "accommodation",
          "searchKeyword": "„Éõ„ÉÜ„É´‰∏Ä‰πÉÈ§®",
          "mapcode": "64 695 540*84",
          "note": "üõèÔ∏è ÊàøÂûãÔºö‰∏ÄÈñìÊàøÔºåÊúâÊó©È§ê\nüìç Âú∞ÂùÄÔºö1262 Izuruharacho, Sano, Tochigi 327-0102\nÈõªË©±Ôºö0283-25-0228\nMapcode: 64 695 540*84\n‰ªªÂãôÔºö\n1. Ëæ¶ÁêÜÂÖ•‰Ωè„ÄÅÊîæË°åÊùé„ÄÇ\n2. Á¢∫Ë™çÊòéÊó©Êó©È§êÊôÇÈñì (Á¥Ñ 07:30)„ÄÇ\n3. ÊãøÊàøÈñìÁöÑÂÜ∞Ê°∂ (ÂéªËµ∞ÂªäË£ΩÂÜ∞Ê©üË£ùÂÜ∞)„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "‰ΩèÂÆøË≤ª", "amount": 13332, "currency": "NT", "category": "accommodation" }
          ],
          "steps": 500
        },
        {
          "id": "d1-6",
          "time": "17:15",
          "title": "Á¨¨ÂõõÁ´ôÔºöË≤∑ÈÖíËªçÁÅ´Â∫´ (YAMAYA)",
          "category": "shopping",
          "searchKeyword": "ÈÖí„ÅÆ„ÇÑ„Åæ„ÇÑ ‰ΩêÈáéÂ∫ó",
          "note": "Âú∞ÈªûÔºöÈÖíÁöÑ YAMAYA ‰ΩêÈáéÂ∫ó („ÇÑ„Åæ„ÇÑ)\nÈõªË©±Ôºö0283-20-4828 (ÈñãÂà∞ 21:00)\nüõí ÂøÖË≤∑Ê¢ÖÈÖíÊ∏ÖÂñÆÔºö\n1. Ê¢Ö‰πÉÂÆø „ÅÇ„Çâ„Åî„ÅóÊ¢ÖÈÖí (ÊûúËÇâÁ≥ªÁéãËÄÖÔºåÂøÖË≤∑ÔºÅ)\n2. È≥≥Âá∞ÁæéÁî∞ ÁÜüÊàêÁßòËîµÊ¢ÖÈÖí (Ê´™Êú®ÈôêÂÆö)\n3. Â±±Â¥éÁÑôÁÖéÊ®ΩÊ¢ÖÈÖí\n4. CHOYA ÈªëÁ≥ñÊ¢ÖÈÖí\nË£úÁµ¶ÔºöÈ†Ü‰æøË≤∑ 2L Â§ßÁì∂Ê∞¥„ÄÅÁÑ°Á≥ñÁ∂†Ëå∂„ÄÇ",
          "expenses": [
             { "id": "e2", "label": "ÈÖíÊ∞¥Êé°Ë≥º", "amount": 10000, "currency": "JPY", "category": "shopping" }
          ],
          "completed": false,
          "type": "normal",
          "steps": 800
        },
        {
          "id": "d1-7",
          "time": "18:00",
          "title": "Á¨¨‰∫îÁ´ôÔºöË∂≥Âà©Ëä±ÂçâÂÖ¨Âúí (ÂÖâ‰πãËä±Â∫≠)",
          "category": "sightseeing",
          "searchKeyword": "„ÅÇ„Åó„Åã„Åå„Éï„É©„ÉØ„Éº„Éë„Éº„ÇØ",
          "mapcode": "64 512 293*12",
          "note": "Mapcode: 64 512 293*12\nÁßªÂãïÔºöÂæÄË•øÈñãÁ¥Ñ 15 ÂàÜÈêò„ÄÇ\nÈõªË©±Ôºö0284-91-4939\nÈáçÈªûÔºöÊó•Êú¨‰∏âÂ§ßÁáàÈ£æÔºåÈùûÂ∏∏Â£ØËßÄ„ÄÇ\nÊ≥®ÊÑèÔºöÈÄôË£°ÈùûÂ∏∏ÂÜ∑ÔºÅÁ©∫Êõ†È¢®Â§ßÔºåË´ãÂÖ®ÂâØÊ≠¶Ë£ù (ÂúçÂ∑æ/ÊâãÂ•ó)„ÄÇ",
          "expenses": [
             { "id": "e3", "label": "Â§úÈñìÈñÄÁ•®", "amount": 0, "currency": "JPY", "category": "sightseeing" }
          ],
          "completed": false,
          "type": "normal",
          "steps": 4000
        },
        {
          "id": "d1-8",
          "time": "20:30",
          "title": "Á¨¨ÂÖ≠Á´ôÔºöÊ∂àÂ§úË£úÁµ¶ (AEON)",
          "category": "shopping",
          "searchKeyword": "„Ç§„Ç™„É≥„Çπ„Çø„Ç§„É´‰ΩêÈáéÊñ∞ÈÉΩÂ∏Ç",
          "note": "Âú∞ÈªûÔºöAEON Style ‰ΩêÈáéÊñ∞ÈÉΩÂ∏Ç\nÈõªË©±Ôºö0283-20-5252\nÁõÆÊ®ôÂçÄÔºö1F È£üÂìÅË≥£Â†¥ (ÈñãÂà∞ 23:00)„ÄÇ\nÂøÖË≤∑Ê∏ÖÂñÆÔºö\n1. ÂçäÈ°çÁÜüÈ£ü/ÁÇ∏Áâ©/Â£ΩÂè∏„ÄÇ\n2. Ê´™Êú®Á∏£Áî¢ËçâËéì (Tochiotome)„ÄÇ\n3. ÈÖíÈ°ûË£úÁµ¶„ÄÇ",
          "completed": false,
          "type": "normal",
           "expenses": [
             { "id": "e1", "label": "Ë∂ÖÂ∏ÇÊé°Ë≥º", "amount": 5000, "currency": "JPY", "category": "shopping" }
          ],
          "steps": 1500
        },
        {
          "id": "d1-9",
          "time": "21:30",
          "title": "ËøîÂõûÈ£ØÂ∫óÔºöÂæÆÈÜ∫ Party",
          "category": "other",
          "note": "‰∫´ÂèóÊªøÊ°åÂçäÂÉπÁÜüÈ£ü + ÈÆÆÁîúËçâËéì + Ê¢Ö‰πÉÂÆøÊ¢ÖÈÖí„ÄÇ\n‚ö†Ô∏è D4 ÊâçË¶ÅÂéªËå®ÂüéË≤∑ÁôæÂπ¥Ê¢ÖÈÖíÔºå‰ªäÊôöÂÖàÂñù‰æøÂà©ÂïÜÂ∫óÁöÑ„ÄÇ",
          "completed": false,
          "type": "normal"
        }
    ]},
    {
      "id": "day2",
      "date": "12/29",
      "dayOfWeek": "(‰∏Ä)",
      "weather": "cloudy",
      "location": "‰ΩêÈáé ‚Üí Â•ßÊó•ÂÖâ ‚Üí Â∑ùÊ≤ª",
      "steps": 0,
      "items": [
        {
          "id": "d2-1",
          "time": "07:30",
          "title": "Êó©È§ê & ÈÄÄÊàø",
          "category": "food",
          "note": "Âú∞ÈªûÔºöHotel Ichinokan (Êó•ÂºèÂÆöÈ£ü)„ÄÇ\nÊ∫ñÂÇôÔºöÂêÉÈ£ΩÂæåÈÄÄÊàø„ÄÇË´ãÂ∞áÂéöÂ§ñÂ•ó„ÄÅÂúçÂ∑æÊãøÂá∫‰æÜÊîæÂú®ËªäÂÖßÂ∫ß‰ΩçÊóÅÔºå‰∏äÂ±±È¶¨‰∏äË¶ÅÁ©ø„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d2-2",
          "time": "09:00",
          "title": "Ê∫ñÊôÇÂá∫Áôº (ÁõÆÊ®ôÔºöÊó•ÂÖâ)",
          "category": "transport",
          "note": "Â∞éËà™Ë®≠ÂÆöÔºöËº∏ÂÖ•ÈõªË©± 0288-54-0560 (Êù±ÁÖßÂÆÆÂ§ßÈßêËªäÂ†¥)„ÄÇ\nËªäÁ®ãÔºöÁ¥Ñ 50-60 ÂàÜÈêò (Ëµ∞È´òÈÄü)„ÄÇ\n‚ö†Ô∏è ÈóúÈçµÔºöÁµïÂ∞ç‰∏çË¶ÅÊãñÂà∞ 10:00 ÊâçÂá∫ÈñÄÔºåÂê¶ÂâáÊéíÂÅúËªäÂ†¥ÊúÉËÄóÊéâ 1 Â∞èÊôÇ„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d2-3",
          "time": "10:00",
          "title": "ÂÅúËªäÁ≠ñÁï•",
          "category": "transport",
          "note": "„ÄêÈ¶ñÈÅ∏„ÄëÊó•ÂÖâÊù±ÁÖßÂÆÆ Â§ßÈßêËªäÂ†¥ (0288-54-0560)ÔºöË°®ÂèÉÈÅìÊ≠£‰∏ãÊñπ„ÄÇËã•Èöä‰ºçÊúâÂú®ÂãïÂ∞±Êéí„ÄÇ\n„ÄêÂÇôÊ°à„ÄëË•øÂèÇÈÅìÁ¨¨1ÈßêËªäÂ†¥ (0288-53-0909)ÔºöËã•È¶ñÈÅ∏ÂãïÂΩà‰∏çÂæóÔºåÈ¶¨‰∏äÊéâÈ†≠ÂÅúÈÄôË£° (Ëµ∞Ë∑Ø10ÂàÜÈêò‰∏äÂù°)„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "ÂÅúËªäË≤ªÈ†ê‰º∞", "amount": 1000, "currency": "JPY", "category": "transport" }
          ],
          "steps": 500
        },
        {
          "id": "d2-4",
          "time": "10:15",
          "title": "ÊôØÈªûÔºöÊó•ÂÖâÊù±ÁÖßÂÆÆ",
          "category": "sightseeing",
          "searchKeyword": "Êó•ÂÖâÊù±ÁÖßÂÆÆ",
          "note": "ÂÅúÁïôÊôÇÈñìÔºöÁ¥Ñ 2 ~ 2.5 Â∞èÊôÇ„ÄÇ\nÂøÖÁúãÔºö\n1. ÈôΩÊòéÈñÄ (ÂúãÂØ∂)„ÄÇ\n2. Áú†Ë≤ì (ÈÄöÂæÄÂ•ßÂÆÆÂÖ•Âè£)„ÄÇ\n3. È≥¥Èæç (Ëó•Â∏´Â†ÇËÅΩÂõûÈü≥ÔºåÈúÄËÑ´Èûã)„ÄÇ\n4. Á•ûÂªÑËàç (‰∏âÁåø)„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "ÈñÄÁ•®", "amount": 2600, "currency": "JPY", "category": "sightseeing" }
          ],
          "steps": 6000
        },
        {
          "id": "d2-5",
          "time": "12:45",
          "title": "ÂçàÈ§êÔºöÈ†ÜË∑ØÂ§ñÂ∏∂ (ÈáëË∞∑È£ØÂ∫óÊ≠∑Âè≤È§®)",
          "category": "food",
          "searchKeyword": "ÈáëË∞∑„Éõ„ÉÜ„É´Ê≠¥Âè≤È§® „Ç´„ÉÜ„ÉÉ„Ç∏„Ç§„É≥„Éª„É¨„Çπ„Éà„É©„É≥",
          "note": "‰ΩçÁΩÆÔºöÂúãÈÅì120Ëôü‰∏äÔºåÁ∂ìÈÅéÁ•ûÊ©ãÂæåÁ¥Ñ 3-5 ÂàÜÈêò (Âè≥ÊâãÈÇä)„ÄÇ\nÈõªË©±Ôºö0288-50-1873\nÂøÖË≤∑ËèúÂñÆÔºö\nü•á Â§¢ÂπªË±¨Êéí‰∏âÊòéÊ≤ª (¬•1,200)\nü•à Êó•ÂÖâÈÆ≠È≠öÂíñÂì©È£Ø (¬•1,500)\nüçû ÈáëË∞∑ÂíñÂì©È∫µÂåÖ\nÂÇôÊ°àÔºö„Çå„Çì„Ååya (ÁÇíÈ∫µËÄÅÂ∫ó) 0288-54-0733„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "Ë±¨Êéí‰∏âÊòéÊ≤ª", "amount": 1200, "currency": "JPY", "category": "food" },
             { "id": "e2", "label": "ÈÆ≠È≠öÂíñÂì©", "amount": 1500, "currency": "JPY", "category": "food" }
          ]
        },
        {
          "id": "d2-6",
          "time": "13:30",
          "title": "ÂÖúÈ¢®ÔºöÊåëÊà∞„Äå‰ºä„ÅÑ„Çç„ÅØÂùÇ„Äç",
          "category": "transport",
          "note": "Ë∑ØÊ≥ÅÔºöÂñÆÂêëÈÄöË°åÁöÑÂ±±Ë∑ØÔºå48 ÂÄãÈ´ÆÂ§æÂΩé„ÄÇ\nÈßïÈßõÊ≥®ÊÑèÔºöÂÆπÊòìÊöàËªäËÄÖË´ãÂÖàÂêÉËó•„ÄÇÈÇäÈñãÈÇä‰∫´ÂèóËªä‰∏äÁöÑ‰∏âÊòéÊ≤ªÂçàÈ§êÔºÅ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d2-7",
          "time": "14:15",
          "title": "ÊôØÈªûÔºöÂ•ßÊó•ÂÖâ (ËèØÂö¥ÁÄëÂ∏É)",
          "category": "sightseeing",
          "searchKeyword": "ËèØÂé≥„ÅÆÊªù",
          "note": "ÈõªË©±Ôºö0288-55-0030 (Á∏£ÁáüÂÅúËªäÂ†¥)„ÄÇ\nÂøÖÂÅöÔºö\n1. Êê≠ÈõªÊ¢Ø (570ÂÜÜ) ‰∏ãÂéªËßÄÁÄëÂè∞ÁúãÂÜ∞ÁÄë„ÄÇ\n2. ‰∏≠Á¶™ÂØ∫ÊπñÊï£Ê≠•„ÄÇ\n‚ö†Ô∏è Êí§ÈÄÄÊ≠ªÁ∑öÔºö16:00 ÂâçÂøÖÈ†à‰∏ãÂ±±„ÄÇÂ§™ÈôΩ‰∏ãÂ±±ÂæåË∑ØÈù¢ÊòìÁµêÂÜ∞„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "ËßÄÁÄëÈõªÊ¢Ø", "amount": 570, "currency": "JPY", "category": "sightseeing" }
          ],
          "steps": 2500
        },
        {
          "id": "d2-8",
          "time": "17:30",
          "title": "ÊôöÈ§êÔºö‰ªäÂ∏ÇÁÇ∏Ë±¨Êéí („ÅÇ„Å•„Åæ)",
          "category": "food",
          "searchKeyword": "„Å®„Çì„Åã„Å§ „ÅÇ„Å•„Åæ",
          "note": "‰ΩçÁΩÆÔºö‰∏ãÂ±±ÂæÄÂ∑ùÊ≤ªÁöÑÈ†ÜË∑ØÈÄî‰∏≠„ÄÇ\nÈõªË©±Ôºö0288-22-5878\nÂøÖÈªûÔºöÂíåË±ö„ÇÇ„Å°„Å∂„ÅüÁÇ∏Ë±¨ÊéíÂÆöÈ£ü„ÄÇ\n‚ö†Ô∏è ÂÇôÊ°àÁ¢∫Ë™çÔºöGoogle Maps È°ØÁ§∫ÁáüÊ•≠‰∏≠‰∏ç‰∏ÄÂÆöÊ∫ñ„ÄÇËã•Âà∞ÁèæÂ†¥Ê≤íÈñãÔºåÁõ¥Êé•ÂéªÂÇôÊ°àË∂ÖÂ∏Ç„ÄÇ\nÂÇôÊ°àÔºöLion D'or È¨ºÊÄíÂ∑ùÂ∫ó (Ë∂ÖÂ∏Ç) 0288-70-1311„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "È†ê‰º∞È§êË≤ª", "amount": 4000, "currency": "JPY", "category": "food" }
          ]
        },
        {
          "id": "d2-9",
          "time": "19:00",
          "title": "È£ØÂ∫ó Check-in (ÂØøÂ∫µ)",
          "category": "accommodation",
          "searchKeyword": "Á•ù„ÅÑÂÆø ÂØøÂ∫µ",
          "mapcode": "367 835 100*67",
          "note": "üõèÔ∏è ÊàøÂûãÔºöÊó•ÂºèÂõõ‰∫∫ÊàøÔºåÊúâÊó©È§ê\nüìç Âú∞ÂùÄÔºöKawaji 52, Nikko, Tochigi 321-2611\nÈõªË©±Ôºö0288-78-1101\nMapcode: 367 835 100*67\n‚ö†Ô∏è ÈáçË¶ÅÔºöÂõ†ÊúÉÊôöÂà∞ (19:00)ÔºåË´ãÂú® **D1 È£ØÂ∫óÈÄÄÊàøÊôÇ**ÔºåË´ãÊ´ÉÂè∞Âπ´ÂøôÊâìÈõªË©±Áµ¶‰ªäÊôöÈ£ØÂ∫óÂëäÁü•ÊúÉÊôöÂà∞ (19:00)Ôºå‰ª•ÂÖçË¢´ÈéñÈñÄ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "‰ΩèÂÆøË≤ª", "amount": 18311, "currency": "NT", "category": "accommodation" }
          ]
        }
      ]
    },
    {
      "id": "day3",
      "date": "12/30",
      "dayOfWeek": "(‰∫å)",
      "weather": "snow",
      "location": "Â•ßÊó•ÂÖâËàáÁßòÂ¢ÉÊπØË•øÂ∑ù",
      "steps": 0,
      "items": [
        {
          "id": "d3-1",
          "time": "10:00",
          "title": "Âá∫ÁôºÔºöÂ∑ùÊ≤ªÊ∫´Ê≥â ÂØøÂ∫µ",
          "category": "transport",
          "note": "Ê∫ñÂÇôÔºöÈÄÄÊàøÔºåÁ¢∫Ë™çËªä‰∏äÈõ™Âà∑‰ΩçÁΩÆ„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d3-2",
          "time": "10:10",
          "title": "ÊôØÈªûÔºöÈæçÁéãÂ≥Ω",
          "category": "sightseeing",
          "searchKeyword": "ÈæçÁéãÂ≥°",
          "mapcode": "367 686 704*87",
          "note": "Â∞éËà™ÈõªË©±Ôºö0288-77-1053 (Êó¨ËèúËîµ)\nMapcode: 367 686 704*87\nÂÅúËªäÔºöÂÖçË≤ª„ÄÇ\nÁé©Ê≥ïÔºöËµ∞„ÄåÁôΩÈæçÂ≥Ω„ÄçÊ≠•ÈÅìËá≥ËôπË¶ãÊ©ãÊãçÁÖß„ÄÇËã•Ê≠•ÈÅìÁµêÂÜ∞Ë´ãÂãøÂãâÂº∑„ÄÇ\nÂ§©Ê∞£È†êË≠¶Ôºö‚ùÑÔ∏è Ê•µÂÜ∑/Â§ßÈõ™Ê©üÁéáÈ´ò„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 3000
        },
        {
          "id": "d3-new-1",
          "time": "11:15",
          "title": "„ÄêÈáçË¶Å„ÄëÊúÄÂæåË£úÁµ¶Ôºö7-Eleven È¨ºÊÄíÂ∑ùÁ´ãÂ≤©Â∫ó",
          "category": "shopping",
          "searchKeyword": "„Çª„Éñ„É≥-„Ç§„É¨„Éñ„É≥ È¨ºÊÄíÂ∑ùÁ´ãÂ≤©Â∫ó",
          "note": "Â∞éËà™ÈõªË©±Ôºö0288-77-2277\n‰ªªÂãôÔºöÈÄôÊòØÈÄ≤Ê∑±Â±±ÂâçÊúÄÂæå‰∏ÄÂÆ∂ 24h Ë∂ÖÂïÜ„ÄÇÂøÖË≤∑ÈÖí„ÄÅÈõ∂È£ü„ÄÅÂÆµÂ§ú„ÄÅÊ∞¥„ÄÅÊöñÊöñÂåÖ„ÄÇ\nË≤∑ÂÆåÂæåË™øÈ†≠ÂæÄÂåóÔºåÊ≠£ÂºèÂâçÂæÄÊπØË•øÂ∑ù„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 500
        },
        {
          "id": "d3-3",
          "time": "12:10",
          "title": "ÂçàÈ§êÔºöÈÅì„ÅÆÈßÖ ÊπØË•øÂ∑ù",
          "category": "food",
          "searchKeyword": "ÈÅì„ÅÆÈßÖ ÊπØË•øÂ∑ù",
          "note": "Â∞éËà™ÈõªË©±Ôºö0288-78-1222\nüö´üêÇ ‰∏çÂêÉÁâõÊîªÁï•Ôºö\n1. È¥®ËÇâËí∏Á±†ËïéÈ∫•È∫µ (È¥®ËÇâÊòØÂêçÁî¢)\n2. Ê∞¥Â£©ÂíñÂì© (ÈªûÈ¥®ËÇâÊàñÈáéËèúÂè£Âë≥)\n3. ÈπøËÇâÂèØÊ®ÇÈ§Ö (ÈáéÂë≥)\nÈñÄÂè£ÊúâÂÖçË≤ªË∂≥ÊπØ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "È†ê‰º∞È§êË≤ª", "amount": 3000, "currency": "JPY", "category": "food" }
          ]
        },
        {
          "id": "d3-4",
          "time": "14:00",
          "title": "ÊôØÈªûÔºöÂπ≥ÂÆ∂‰πãÈáå",
          "category": "sightseeing",
          "searchKeyword": "Âπ≥ÂÆ∂„ÅÆÈáå",
          "mapcode": "716 161 037*14",
          "note": "Â∞éËà™ÈõªË©±Ôºö0288-98-0126\nÁáüÊ•≠Ôºö~16:30 (ÊúÄÁµÇÂÖ•Â†¥ 16:00)\nÁúãÈªûÔºöËåÖËçâÂ±ãËÅöËêΩËàáÈõ™ÊôØ„ÄÇÂÖßÊúâËå∂Â±ãÂèØÂñùÁÜ±Á¥ÖË±ÜÊπØ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "ÈñÄÁ•®", "amount": 1020, "currency": "JPY", "category": "sightseeing" }
          ],
          "steps": 2500
        },
        {
          "id": "d3-5",
          "time": "15:10",
          "title": "È£ØÂ∫ó Check-in (Êú¨ÂÆ∂‰º¥‰πÖ)",
          "category": "accommodation",
          "searchKeyword": "Êú¨ÂÆ∂‰º¥‰πÖ",
          "mapcode": "716 161 037*14",
          "note": "üõèÔ∏è ÊàøÂûãÔºöÊó•ÂºèÂõõ‰∫∫ÊàøÔºåÊúâÊôöÈ§ê„ÄÅÊó©È§ê\nüìç Âú∞ÂùÄÔºöYunishikawa 749, Nikko, Tochigi 321-2601\nÂ∞éËà™ÈõªË©±Ôºö0288-98-0011\nMapcode: 716 161 037*14\nÂÖ•‰Ωè SOPÔºö\n1. ‰ª£ÂÆ¢Ê≥äËªä„ÄÇ\n2. Á¢∫Ë™çÊôöÈ§ê (Check-in ÊôÇÂÜçÊ¨°ÊèêÈÜí‰∏çÂêÉÁâõÔºö‰∫àÁ¥ÑÊôÇ„Å´ÁâõËÇâNG„Å®‰ºù„Åà„Åæ„Åó„Åü)„ÄÇ\n3. È†êÁ¥ÑÊó©È§êÊôÇÈñì (7:30/8:00/8:30)„ÄÇ\n‰∫´ÂèóÔºöÈú≤Â§©È¢®ÂëÇ & ÂúçÁàêË£èÊôöÈ§ê„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "‰ΩèÂÆøË≤ª", "amount": 24134, "currency": "NT", "category": "accommodation" }
          ]
        }
      ]
    },
    {
      "id": "day4",
      "date": "12/31",
      "dayOfWeek": "(‰∏â)",
      "weather": "sunny",
      "location": "Èõ™Â±± ‚Üí Êµ∑Êø± (Èô§Â§ïÂúçÁàê)",
      "steps": 0,
      "items": [
        {
          "id": "d4-1",
          "time": "10:00",
          "title": "Âá∫ÁôºÔºöÂâçÂæÄÂ§ßÊ¥ó (ÁßªÂãïÊó•)",
          "category": "transport",
          "note": "‚ö†Ô∏è ÈßïÈßõÊ≥®ÊÑèÔºö‰∏ãÂ±±Ë∑ØÊÆµ (ÂúãÈÅì121Ëôü) ÈößÈÅìÂá∫Âè£ÂèØËÉΩÊúâÈªëÂÜ∞ÔºåÂãøÊÄ•ÁÖû„ÄÇ\nÂ∞éËà™Ë®≠ÂÆöÔºöÁ¨¨‰∏ÄÁ´ôË®≠ÂÆö„ÄåÁ¨†Èñì PA (0296-70-1200)„Äç„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d4-new-1",
          "time": "11:45",
          "title": "‰ºëÊÅØÔºöÁ¨†Èñì PA (Kasama)",
          "category": "food",
          "note": "ÁâπËâ≤ÔºöË®≠ÊñΩÊñ∞„ÄÅÂªÅÊâÄ‰πæÊ∑®„ÄÇ\nÂøÖÂêÉÔºöÁ¨†ÈñìÁ®ªËç∑Â£ΩÂè∏ (Ê†∏Ê°É/ËàûËèáÂè£Âë≥ÔºåÁÑ°ÁâõOK)„ÄÅÁµ≤ÊªëÂú∞ÁìúËíôÂ∏ÉÊúó„ÄÇ\nÊ≥®ÊÑèÔºöÂà•ÈÄõÂ§™‰πÖÔºåÁïôËÇöÂ≠êÂéªÂ§ßÊ¥óÂêÉÊµ∑ÈÆÆ„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 500
        },
        {
          "id": "d4-2",
          "time": "13:00",
          "title": "ÂçàÈ§êÔºöÂ§ßÊ¥óÊµ∑ÈÆÆ (‰∫åÈÅ∏‰∏Ä)",
          "category": "food",
          "searchKeyword": "Â§ßÊ¥óÊµ∑ÈÆÆÂ∏ÇÂ†¥",
          "note": "ÈÅ∏È†Ö A (Âø´ÈÄü)ÔºöÊòéÂ§™ÂÖ¨Âúí (029-219-4101) - Â∑®ÁÑ°Èú∏È£ØÁ≥∞„ÄÇ\nÈÅ∏È†Ö B (Ë±êÁõõ)ÔºöÂ§ßÊ¥óÊµ∑ÈÆÆÂ∏ÇÂ†¥ (029-267-0111) - Êµ∑ÈÆÆ‰∏º„ÄÅÊø±Ááí„ÄÅÈÆüÈ±áÈ≠öÈçã„ÄÇ\nÊ≥®ÊÑèÔºöÈô§Â§ï‰∫∫ÊΩÆÂ§öÂèØËÉΩÈúÄÊéíÈöä„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d4-3",
          "time": "14:30",
          "title": "ÊôØÈªûÔºöÂ§ßÊ¥óÁ£ØÂâçÁ•ûÁ§æ",
          "category": "sightseeing",
          "searchKeyword": "Â§ßÊ¥óÁ£ØÂâçÁ•ûÁ§æ",
          "mapcode": "239 535 445*58",
          "note": "Â∞éËà™ÈõªË©±Ôºö029-267-2637\nMapcode: 239 535 445*58\nÁé©Ê≥ïÔºöÂÖàÂèÉÊãúÊú¨ÊÆøÔºåÂÜçËµ∞‰∏ãÂéªÊµ∑ÈÇäÊãç„ÄåÁ•ûÁ£ØÈ≥•Â±Ö„Äç„ÄÇ\nÊ≥®ÊÑèÔºöÊµ∑È¢®Ê•µÂº∑ÔºåË´ãÊà¥Â∏ΩÂ≠êÂúçÂ∑æ„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 2500
        },
        {
          "id": "d4-4",
          "time": "15:40",
          "title": "Ë≤∑ÈÖíÔºöÂ§ßÊ¥ó Seaside Station",
          "category": "shopping",
          "searchKeyword": "Â§ßÊ¥ó„Ç∑„Éº„Çµ„Ç§„Éâ„Çπ„ÉÜ„Éº„Ç∑„Éß„É≥",
          "mapcode": "239 506 461*34",
          "note": "Â∞éËà™ÈõªË©±Ôºö029-264-9123\nMapcode: 239 506 461*34\nÁõÆÊ®ôÔºöÂ§ßÊ¥ó„Åæ„ÅÑ„Çè„ÅÑÂ∏ÇÂ†¥„ÄÇ\nÂøÖË≤∑ÔºöÁôæÂπ¥Ê¢ÖÈÖí (ÊòéÂà©ÈÖíÈ°ûÔºåËóçÊ®ôÊàñÁ¥ÖÊ®ô)„ÄÅÂú∞Áìú‰πæ (Ëå®ÂüéÁâπÁî¢)„ÄÇ\nÁîüÈÆÆÂéª‰∏ã‰∏ÄÁ´ôË∂ÖÂ∏ÇË≤∑„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 1000
        },
        {
          "id": "d4-new-2",
          "time": "16:40",
          "title": "„ÄêÊà∞Â†¥„ÄëÈô§Â§ïÊôöÈ§êÊé°Ë≤∑ÔºöKasumi Ë∂ÖÂ∏Ç",
          "category": "shopping",
          "searchKeyword": "„Ç´„Çπ„Éü „Éï„Éº„Éâ„Çπ„ÇØ„Ç®„Ç¢ Ê∞¥Êà∏Ë•øÂéüÂ∫ó",
          "note": "Âú∞ÈªûÔºöKasumi Food Square Ê∞¥Êà∂Ë•øÂéüÂ∫ó (029-253-4611)„ÄÇ\nÂøÖË≤∑ (‰∏çÂêÉÁâõ)Ôºö\n1. Ëå®ÂüéÁî£„É≠„Éº„Ç∫„Éù„Éº„ÇØ (Rose Pork) Ë±¨ËÇâÁâá„ÄÇ\n2. ÁÅ´ÈçãÊπØÂ∫ï (Êµ∑ÈÆÆ/ÈõûÊπØ/Ë±Ü‰π≥ÔºåÁ¢∫Ë™çÁÑ°ÁâõÊ≤π)„ÄÇ\n3. Ë±™ËèØÁîüÈ≠öÁâá„ÄÅË∑®Âπ¥ËïéÈ∫•È∫µ (ÁÇ∏Ëù¶)„ÄÇ\n4. Ëå®ÂüéËçâËéì„ÄÇ\n‚ö†Ô∏è 17:00 ÂâçÂÖ•Â†¥Ôºå‰ª•ÂÖçÁÜüÈ£üË¢´Êê∂ÂÖâ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e-ny", "label": "Èô§Â§ïÊé°Ë≥ºÈ†êÁÆó", "amount": 5000, "currency": "JPY", "category": "shopping" }
          ],
          "steps": 1500
        },
        {
          "id": "d4-5",
          "time": "18:00",
          "title": "Ê∞ëÂÆø Check-in (Mito House)",
          "category": "accommodation",
          "searchKeyword": "‰∏ÄÊ£üË≤∏„Åó„ÅÆÂÆø Ê∞¥Êà∏„Éè„Ç¶„Çπ",
          "mapcode": "47 161 388*03",
          "note": "üõèÔ∏è ÊàøÂûãÔºöÂåÖÊ£üÔºåÊ≤íÊó©È§ê\nüìç Âú∞ÂùÄÔºö1 Chome-2-55 Kanemachi, Mito, Ibaraki 310-0066\nÈõªË©±Ôºö090-5639-7300\nMapcode: 47 161 388*03\nÊôö‰∏äÔºöÁÖÆÁÅ´Èçã„ÄÅÂêÉËïéÈ∫•È∫µ„ÄÅÂñùÊ¢ÖÈÖí„ÄÅÁúãÁ¥ÖÁôΩ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "‰ΩèÂÆøË≤ª", "amount": 9316, "currency": "NT", "category": "accommodation" }
          ]
        }
      ]
    },
    {
      "id": "day5",
      "date": "1/1",
      "dayOfWeek": "(Âõõ)",
      "weather": "sunny",
      "location": "‰∏ñÁïåÂ§ß‰ΩõËàáÁ≠ëÊ≥¢Â±±ËøéÊñ∞",
      "steps": 0,
      "items": [
        {
          "id": "d5-1",
          "time": "10:00",
          "title": "Âá∫ÁôºÔºöÂâçÂæÄ Outlet",
          "category": "transport",
          "note": "Á≠ñÁï•ÔºöÈÅøÈñãÁ•ûÁ§æËªäÊΩÆÔºåËµ∞ÂÖßÈô∏ËàíÈÅ©Ë∑ØÁ∑ö„ÄÇ\nÂ∞éËà™ÔºöAmi Premium Outlets (029-829-5770)„ÄÇ\nË∑ØÂæëÔºö‰∏äÂ∏∏Á£êÈÅì (È´òÈÄü)ÔºåÈÅøÈñãÂπ≥Èù¢„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d5-2",
          "time": "11:00",
          "title": "ÂçàÈ§ê+ÈÄõË°óÔºöAmi Premium Outlets",
          "category": "shopping",
          "searchKeyword": "„ÅÇ„Åø„Éó„É¨„Éü„Ç¢„É†„Éª„Ç¢„Ç¶„Éà„É¨„ÉÉ„Éà",
          "note": "ÁâπËâ≤Ôºö1/1 ÂàùÂ£≤„ÇäÔºåÂ•ΩÂÅúËªä„ÄÇ\nüçΩÔ∏è ‰∏çÂêÉÁâõÂçàÈ§êÔºö\n1. Kua`Aina (ÈÖ™Ê¢®ÈõûËÇâ‰∏âÊòéÊ≤ª/ÁÇ∏È≠ö)„ÄÇ\n2. Chinrai (Áèç‰æÜ) - ÁÇíÈ£Ø„ÄÅÂ§ßÈ§ÉÂ≠ê„ÄÇ\n3. ÊàêÁî∞Â§¢ÁâßÂ†¥ÈúúÊ∑áÊ∑ã„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "ÂçàÈ§ê+Ë≥ºÁâ©È†êÁÆó", "amount": 5000, "currency": "JPY", "category": "food" }
          ],
          "steps": 6000
        },
        {
          "id": "d5-3",
          "time": "13:40",
          "title": "ÊôØÈªûÔºöÁâõ‰πÖÂ§ß‰Ωõ",
          "category": "sightseeing",
          "searchKeyword": "Áâõ‰πÖÂ§ß‰ªè",
          "mapcode": "65 086 720*25",
          "note": "Â∞éËà™ÈõªË©±Ôºö029-889-2931 (Èõ¢ Outlet 5ÂàÜÈêò)„ÄÇ\nÊîªÁï•ÔºöÊãçÂ§ñËßÄÂ∞±Â•Ω„ÄÇËã•ÈÄ≤ÂÖßÈÉ®ÈõªÊ¢ØÊéíÈöäË∂ÖÈÅé 30 ÂàÜÈêòÂª∫Ë≠∞ÊîæÊ£ÑÔºåÂú®Â§ß‰ΩõËÖ≥‰∏ãÊï≤ÈêòÁ•àÁ¶èÂç≥ÂèØ„ÄÇ",
          "completed": false,
          "type": "normal",
           "expenses": [
            { "id": "1", "label": "ÈñÄÁ•®È†êÁÆó", "amount": 2000, "currency": "JPY", "category": "sightseeing" }
          ],
          "steps": 2000
        },
        {
          "id": "d5-4",
          "time": "15:30",
          "title": "È£ØÂ∫ó Check-in (Èæú‰πã‰∫ï Á≠ëÊ≥¢Â±±)",
          "category": "accommodation",
          "searchKeyword": "‰∫Ä„ÅÆ‰∫ï„Éõ„ÉÜ„É´ Á≠ëÊ≥¢Â±±",
          "mapcode": "123 477 064*47",
          "note": "üõèÔ∏è ÊàøÂûãÔºöÊó•ÂºèÂõõ‰∫∫ÊàøÔºåÊúâÊôöÈ§ê„ÄÅÊó©È§ê\nüìç Âú∞ÂùÄÔºö1050-1 Tsukuba, Ibaraki 300-4352\nÂ∞éËà™ÈõªË©±Ôºö029-866-1111\nMapcode: 123 477 064*47\nÈÅøÂ°ûËªäÔºöËã•ÈÅáÁ•ûÁ§æËªäÊΩÆÔºåÂá∫Á§∫Ë®ÇÊàøÁï´Èù¢Áµ¶‰∫§ÁÆ°Áúã„ÄåHotel Check-in„ÄçÂèØÂÑ™ÂÖàÈÄöÈÅé„ÄÇ\n‰∫´ÂèóÔºöË∂ÅÂ§©‰∫ÆÂéªÊ≥°ÁÑ°ÈÇäÈöõÈú≤Â§©Ê∫´Ê≥âÁúãÂ§ïÈôΩ„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "‰ΩèÂÆøË≤ª", "amount": 23951, "currency": "NT", "category": "accommodation" }
          ]
        },
        {
          "id": "d5-5",
          "time": "16:30",
          "title": "Êï£Ê≠•ÔºöÁ≠ëÊ≥¢Â±±Á•ûÁ§æ (ÂàùË©£)",
          "category": "sightseeing",
          "searchKeyword": "Á≠ëÊ≥¢Â±±Á•ûÁ§æ",
          "mapcode": "123 477 072*85",
          "note": "‰∫§ÈÄöÔºöÂæûÈ£ØÂ∫óËµ∞Ë∑Ø 5-10 ÂàÜÈêò„ÄÇ\nÁâπËâ≤ÔºöÂÇçÊôöÁáàÁ±†‰∫ÆËµ∑Ê∞£Ê∞õ‰Ω≥ÔºåÈÅøÈñãÁôΩÂ§©‰∫∫ÊΩÆ„ÄÇÂèÉÊãúÂæåÂèØË≤∑Â±ãÂè∞Â∞èÂêÉ„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 1500
        },
        {
          "id": "d5-6",
          "time": "18:00",
          "title": "ÊôöÈ§êÔºöÈ£ØÂ∫óËá™Âä©È§ê",
          "category": "food",
          "note": "ÊîªÁï•ÔºöÂ∞àÊîªÁîüÈ≠öÁâá„ÄÅÂ§©Â©¶ÁæÖ„ÄÅËå®ÂüéË±¨ËÇâÊñôÁêÜ„ÄÇÊ≥®ÊÑèÂíñÂì©ÈÄöÂ∏∏Âê´Áâõ„ÄÇ",
          "completed": false,
          "type": "normal"
        }
      ]
    },
    {
      "id": "day6",
      "date": "1/2",
      "dayOfWeek": "(‰∫î)",
      "weather": "cloudy",
      "location": "Ëå®ÂüéËçâËéì ‚Üí Êù±‰∫¨ÈòøÁæéÊ©´‰∏Å",
      "steps": 0,
      "items": [
        {
          "id": "d6-1",
          "time": "10:00",
          "title": "Âá∫ÁôºÔºöÂâçÂæÄËçâËéìÂúí",
          "category": "transport",
          "note": "Â∞éËà™Ë®≠ÂÆöÔºöGRANBERRY (0297-44-6615)„ÄÇ\nË∑ØÊ≥ÅÔºöÂæÄÂ∏∏Á∏ΩÂ∏ÇÊñπÂêëÔºåË∑ØÂ•ΩËµ∞„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d6-2",
          "time": "11:00",
          "title": "È´îÈ©óÔºöGRANBERRY ËçâËéìÂêÉÂà∞È£Ω",
          "category": "food",
          "searchKeyword": "GRANBERRY Â§ßÂú∞",
          "mapcode": "18 853 864*14",
          "note": "Mapcode: 18 853 864*14\nÁâπËâ≤ÔºöÈ´òÊû∂Ê†ΩÂüπ‰∏çÈ´íÈûãÔºå40ÂàÜÈêòÂêÉÂà∞È£Ω„ÄÇ\n‚ö†Ô∏è ÈáçË¶ÅÔºöÂº∑ÁÉàÂª∫Ë≠∞È†êÁ¥Ñ„ÄÇËã•ÂÆ¢ÊªøÔºåÂÇôÊ°àÊòØÂéª‰∏ã‰∏ÄÁ´ô Pasar ÂÆàË∞∑Ë≤∑ËçâËéì„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "È´îÈ©óË≤ª", "amount": 2800, "currency": "JPY", "category": "food" }
          ],
          "steps": 500
        },
        {
          "id": "d6-new-1",
          "time": "12:30",
          "title": "ÂçàÈ§êÔºöPasar ÂÆàË∞∑ (‰∏äË°å)",
          "category": "food",
          "note": "‰ΩçÁΩÆÔºöÂ∏∏Á£êÈÅìÂæÄÊù±‰∫¨ÊñπÂêë‰ºëÊÅØÁ´ô„ÄÇ\n‰∏çÂêÉÁâõÊé®Ëñ¶ÔºöÂ§ßÊ¥óÂøó„ÇÄ„Çâ(Êµ∑ÈÆÆ‰∏º)„ÄÅÈ∂è‰∏âÂíå(Ë¶™Â≠ê‰∏º)„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d6-new-2",
          "time": "15:30",
          "title": "ÊäµÈÅîÊù±‰∫¨ÔºöÊ∞ëÂÆø‰∏ãË°åÊùé & ÂÅúËªä",
          "category": "transport",
          "note": "üõèÔ∏è ÊàøÂûãÔºöÂåÖÊ£ü Ê≤íÊó©È§ê ÊúâÂªöÊàø\nüìç Âú∞ÂùÄÔºö2 Chome-4-9 Kitaueno, Taito City 110-0014\nÈõªË©±Ôºö070-8960-5885\nMapcode: 769 494*86\nüÖøÔ∏è ÂÅúËªäÊîªÁï•ÔºöÂÖà‰∏ãË°åÊùé„ÄÇÂãôÂøÖÊâæÁúãÊùøÂØ´„ÄåÂÖ•Â∫´Âæå24ÊôÇÈñì ÊúÄÂ§ßÊñôÈáë„ÄçÁöÑÂÅúËªäÂ†¥ (Á¥Ñ ¬•2500~3500)„ÄÇÂÅúÂ•ΩÂæåÊîπÊê≠ÈõªËªä„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d6-3",
          "time": "16:30",
          "title": "ÈÄõË°óÔºö‰∏äÈáéÈòøÁæéÊ©´‰∏Å",
          "category": "shopping",
          "searchKeyword": "„Ç¢„É°Ê®™",
          "note": "Ê∞£Ê∞õÔºöÊñ∞Âπ¥È¶ñË≥£ (ÂàùÂ£≤„Çä) ÈùûÂ∏∏ÁÜ±È¨ß„ÄÇ\nÂøÖÈÄõÔºö‰∫åÊú®ÁöÑËèìÂ≠ê (‰º¥ÊâãÁ¶Æ)„ÄÅÂ§öÊÖ∂Â±ã (Á¥´Ëâ≤Â§ßÊ®ì)„ÄÅËó•Â¶ùÂ∫ó„ÄÇ",
          "completed": false,
          "type": "normal",
          "steps": 6000
        },
        {
          "id": "d6-new-3",
          "time": "19:00",
          "title": "ÊôöÈ§êÔºö‰∏äÈáéÁÇ∏Ë±¨Êéí (‰∏çÂêÉÁâõÈ¶ñÈÅ∏)",
          "category": "food",
          "searchKeyword": "Ëì¨Ëé±Â±ã",
          "note": "Êé®Ëñ¶ 1ÔºöËì¨ËêäÂ±ã (ÊùæÂùÇÂ±ãÂæå) - ÂøÖÈªûËÖ∞ÂÖßËÇâ (Hire-katsu)„ÄÇ\nÊé®Ëñ¶ 2Ôºö‰∫ïÊ≥â Êú¨Â∫ó (ÊπØÂ≥∂Á´ô) - Á≠∑Â≠êËÉΩÂàáÊñ∑ÁöÑË±¨Êéí„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "e1", "label": "È†ê‰º∞È§êË≤ª", "amount": 3000, "currency": "JPY", "category": "food" }
          ]
        },
        {
          "id": "d6-4",
          "time": "20:30",
          "title": "Ê∞ëÂÆø‰ºëÊÅØ (‰∏äÈáéÊÇ†ÊÇ†‰πãÂÆ∂)",
          "category": "accommodation",
          "searchKeyword": "‰∏äÈáéÊÇ†ÊÇ†‰πãÂÆ∂",
          "mapcode": "769 494*86",
          "note": "Êï¥ÁêÜÊà∞Âà©ÂìÅÔºåÊ∫ñÂÇôÊòéÂ§©ÂõûÂúã„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
            { "id": "1", "label": "‰ΩèÂÆøË≤ª", "amount": 10115, "currency": "NT", "category": "accommodation" }
          ]
        }
      ]
    },
    {
      "id": "day7",
      "date": "1/3",
      "dayOfWeek": "(ÂÖ≠)",
      "weather": "sunny",
      "location": "Êù±‰∫¨ ‚Üí ÂõûÂÆ∂",
      "steps": 0,
      "items": [
        {
          "id": "d7-1",
          "time": "08:00",
          "title": "Âá∫ÁôºÔºöÂâçÂæÄÊàêÁî∞Ê©üÂ†¥",
          "category": "transport",
          "note": "‚ö†Ô∏è ÊèêÊó©Âá∫ÁôºÔºöÈÅøÈñãÈ¶ñÈÉΩÈ´ò/Ê©üÂ†¥Â°ûËªä„ÄÇÊúÄÂæå‰∏ÄÂ§©Ë´ãÈ†êÁïôÂÖÖË£ïÊôÇÈñì„ÄÇ",
          "completed": false,
          "type": "normal"
        },
        {
          "id": "d7-2",
          "time": "10:00",
          "title": "Ê©üÂ†¥ÈÇÑËªä (P1ÈßêËªäÂ†¥)",
          "category": "transport",
          "note": "ÈÇÑËªäÂú∞ÈªûÔºöÊàêÁî∞Á©∫Ê∏ØP1ÈßêËªäÂ†¥ (Sakura Rent A Car)„ÄÇ\nÂãï‰ΩúÔºöÊªøÊ≤πÈÇÑËªä„ÄÅÊ™¢Êü•ËªäÊ≥Å„ÄÇ",
          "mapcode": "137 647 682*14",
          "completed": false,
          "type": "normal",
          "steps": 1000
        },
        {
          "id": "d7-etc",
          "time": "10:10",
          "title": "„ÄêÁµêÁÆó„ÄëETC Ëàá Âä†Ê≤π",
          "category": "transport",
          "note": "Ë´ãÂú®Ê≠§ËôïË®òÈåÑÈÄô‰∏ÉÂ§©ÁöÑÈÅéË∑ØË≤ªËàáÊúÄÂæåÂä†Ê≤πÈáëÈ°ç„ÄÇ",
          "completed": false,
          "type": "normal",
          "expenses": [
             { "id": "etc", "label": "ETCÁ∏ΩÈÅéË∑ØË≤ª", "amount": 15000, "currency": "JPY", "category": "transport" },
             { "id": "gas", "label": "Âä†Ê≤πË≤ª", "amount": 5000, "currency": "JPY", "category": "transport" }
          ]
        },
        {
          "id": "d7-3",
          "time": "12:25",
          "title": "Êê≠Ê©üËøîÂè∞ (ÊàêÁî∞T1)",
          "category": "transport",
          "note": "12:25 Âêâ BR107 NRT T1\n13:00 ÁéãÊñπ BR183 NRT T1\n‰∏ÄË∑ØÈ†ÜÈ¢®ÔºÅ‚úàÔ∏è",
          "completed": false,
          "type": "normal",
          "steps": 2000
        }
      ]
    }
];
function App(){
    const [data, setData] = useState(() => {
        const saved = localStorage.getItem('kanto_v2026_final_plus_v39');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                if (Array.isArray(parsed) && parsed.length > 0) {
                    return parsed.filter(d => d && d.id).map(d => ({
                        ...d,
                        items: (d.items || []).filter(i => i && i.id) 
                    }));
                }
            } catch (e) {
                console.error("Data load error", e);
            }
        }
        return INITIAL_ITINERARY;
    });
    const [memos, setMemos] = useState(()=>{
        const saved = localStorage.getItem('kanto_v2026_memos_v39');
        if (!saved) return [];
        try {
            const parsed = JSON.parse(saved);
            const arr = Array.isArray(parsed) ? parsed : Object.values(parsed);
            return arr.filter(m => m && m.id);
        } catch (e) { return []; }
    });
    const [idx,setIdx]=useState(0);
    const [modal,setModal]=useState(false);
    const [ledgerModal, setLedgerModal] = useState(false);
    const [notebookModal, setNotebookModal] = useState(false);
    const [editItem,setEditItem]=useState(null);
    const [editMemoItem, setEditMemoItem] = useState(null); 
    const [sort,setSort]=useState(false);
    const [memoSort, setMemoSort] = useState(false);
    const [backupData, setBackupData] = useState(null); 
    const [stepModal,setStepModal]=useState(false);
    const [tStep,setTStep]=useState('');
    const [saveBtnText, setSaveBtnText] = useState('ÂÑ≤Â≠òÁ¥ÄÈåÑ');
    const [footerExpanded, setFooterExpanded] = useState(true); 
    const [expandedNotes, setExpandedNotes] = useState(new Set());
    const [filterCategory, setFilterCategory] = useState(null);
    const [liveWeather, setLiveWeather] = useState(null); 
    const [menuOpen, setMenuOpen] = useState(false); 
    const [addMenuOpen, setAddMenuOpen] = useState(false);
    const [viewImgIdx, setViewImgIdx] = useState(null); 
    const [showLargeInput, setShowLargeInput] = useState(false);
    const scrollRef = useRef(null);
    const fileRef=useRef(null);
    const stepRef=useRef(null);
    const imgInputRef=useRef(null);
    const urlInputRef=useRef(null);
    const sortableRef = useRef(null);
    const memoSortableRef = useRef(null); 
    const sortableInstance = useRef(null);
    const memoSortableInstance = useRef(null);
    const longPressTimer = useRef(null);

    useEffect(()=>{localStorage.setItem('kanto_v2026_final_plus_v39',JSON.stringify(data))},[data]);
    useEffect(()=>{localStorage.setItem('kanto_v2026_memos_v39',JSON.stringify(memos))}, [memos]);

    useEffect(()=>{
        if(stepModal) {
            setTimeout(() => {
                if(stepRef.current) stepRef.current.focus();
            }, 300);
            setSaveBtnText('ÂÑ≤Â≠òÁ¥ÄÈåÑ');
        }
    },[stepModal]);
    
    useEffect(() => {
        if(viewImgIdx === null) setShowLargeInput(false);
    }, [viewImgIdx]);

    useEffect(() => {
        const fetchWeather = async () => {
            if (!data[idx]) return; 
            const coord = LOCATIONS_COORD.find(c => c.id === data[idx].id);
            if (!coord) return;
            setLiveWeather(null); 
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coord.lat}&longitude=${coord.lng}&current=temperature_2m,weather_code&timezone=Asia%2FTokyo`);
                const json = await res.json();
                if (json.current) {
                    setLiveWeather({
                        temp: Math.round(json.current.temperature_2m),
                        code: json.current.weather_code
                    });
                }
            } catch (e) {
                console.error("Weather fetch failed", e);
            }
        };
        fetchWeather();
    }, [idx, data]);
    
    useEffect(() => {
        if (sort && sortableRef.current) {
            sortableInstance.current = new Sortable(sortableRef.current, {
                animation: 150, 
                handle: ".drag-handle",
                delay: 0, 
                ghostClass: "sortable-ghost",
                dragClass: "sortable-drag",
                onEnd: (evt) => {
                    const { oldIndex, newIndex } = evt;
                    if (oldIndex === newIndex) return;
                    setData(prev => {
                        const newData = [...prev];
                        if (!newData[idx] || !newData[idx].items) return prev;
                        const items = [...newData[idx].items];
                        const cleanItems = items.filter(Boolean);
                        
                        if (oldIndex >= cleanItems.length || newIndex >= cleanItems.length) return prev;

                        const [movedItem] = cleanItems.splice(oldIndex, 1);
                        cleanItems.splice(newIndex, 0, movedItem);
                        
                        newData[idx].items = cleanItems;
                        return newData;
                    });
                }
            });
        } else {
            if (sortableInstance.current) {
                sortableInstance.current.destroy();
                sortableInstance.current = null;
            }
        }
    }, [sort, idx]);

    useEffect(() => {
        if (memoSort && memoSortableRef.current) {
            memoSortableInstance.current = new Sortable(memoSortableRef.current, {
                animation: 150, 
                handle: ".drag-handle-memo",
                delay: 0,
                ghostClass: "sortable-ghost",
                dragClass: "sortable-drag",
                touchStartThreshold: 3,
                onEnd: (evt) => {
                    const { oldIndex, newIndex } = evt;
                    if (oldIndex === newIndex) return;
                    setMemos(prev => {
                        const newMemos = [...prev];
                        if (!newMemos[oldIndex]) return prev;
                        const [movedItem] = newMemos.splice(oldIndex, 1);
                        newMemos.splice(newIndex, 0, movedItem);
                        return newMemos;
                    });
                }
            });
        } else {
            if (memoSortableInstance.current) {
                memoSortableInstance.current.destroy();
                memoSortableInstance.current = null;
            }
        }
    }, [memoSort]);

    const startLongPress = useCallback(() => {
        if (sort) return;
        longPressTimer.current = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50);
            setBackupData(JSON.parse(JSON.stringify(data)));
            setSort(true);
            setFooterExpanded(true);
        }, 800);
    }, [sort, data]);

    const endLongPress = useCallback(() => {
        if (longPressTimer.current) {
            clearTimeout(longPressTimer.current);
            longPressTimer.current = null;
        }
    }, []);

    const cancelSort = () => {
        if (backupData) setData(backupData);
        setSort(false);
        setBackupData(null);
    };
    const finishSort = () => {
        setSort(false);
        setBackupData(null);
    };

    if (!data || data.length === 0) return <div className="p-10 text-center">Ë≥áÊñôËºâÂÖ•ÈåØË™§ÔºåË´ãÈáçË©¶„ÄÇ</div>;
    const day = data[idx] || data[0]; 

    let totalNT=0, totalJPY=0;
    let expensesByCategory = {};
    let allExpenses = [];
    const getSortDate = (dStr) => {
        if(!dStr) return 0;
        const [m, d] = dStr.split('/').map(Number);
        const year = m === 12 ? 2025 : 2026;
        return new Date(year, m - 1, d).getTime();
    };
    data.forEach(d => {
        if(!d || !d.items) return;
        d.items.forEach(i => {
            if(!i) return;
            (i.expenses || []).forEach(ex => {
                const amount = Number(ex.amount || 0);
                if(ex.currency === 'NT') totalNT += amount;
                else totalJPY += amount;
                const cat = ex.category || i.category || 'other';
                if(!expensesByCategory[cat]) expensesByCategory[cat] = { nt:0, jpy:0, label:CATS[cat]?.l || 'ÂÖ∂‰ªñ', color:CATS[cat]?.c || 'bg-gray-100 text-gray-600' };
                if(ex.currency === 'NT') expensesByCategory[cat].nt += amount;
                else expensesByCategory[cat].jpy += amount;
                allExpenses.push({date: d.date, time: i.time, title: i.title, label: ex.label, amount: amount, currency: ex.currency, category: cat, dayId: d.id, itemId: i.id});
            });
        });
    });
    allExpenses.sort((a, b) => {
        const dateA = getSortDate(a.date);
        const dateB = getSortDate(b.date);
        if (dateA !== dateB) return dateA - dateB;
        return a.time.localeCompare(b.time);
    });
    const displayedExpenses = filterCategory ? allExpenses.filter(ex => ex.category === filterCategory) : allExpenses;
    
    const planSteps = day.items ? day.items.reduce((sum, i) => sum + Number(i && i.steps || 0), 0) : 0;
    const displaySteps = day.steps > 0 ? day.steps : planSteps; 

    const liveWeatherType = liveWeather ? getWeatherTypeFromCode(liveWeather.code) : null;
    const weatherIconName = liveWeatherType ? W_ICONS[liveWeatherType] : W_ICONS[day.weather];
    const weatherColorClass = liveWeatherType ? WEATHER_COLORS[liveWeatherType] : WEATHER_COLORS[day.weather];
    const weatherAnimClass = (liveWeatherType || day.weather)==='sunny'?'weather-spin':(liveWeatherType || day.weather)==='cloudy'?'weather-float':'weather-pulse';

    const saveStep=()=>{
        const newData=[...data];
        if(newData[idx]) {
            newData[idx].steps=Number(tStep);
            setData(newData);
            setSaveBtnText('‚úÖ Â∑≤Êõ¥Êñ∞ÔºÅ');
            setTimeout(() => setSaveBtnText('ÂÑ≤Â≠òÁ¥ÄÈåÑ'), 1500);
        }
    };

    const exportData=()=>{
        const backup = { itinerary: data, memos: memos };
        const a=document.createElement('a');
        a.href=URL.createObjectURL(new Blob([JSON.stringify(backup)],{type:'application/json'}));
        a.download='Ë°åÁ®ãËàáÁ≠ÜË®òÂÇô‰ªΩ.json';a.click()
    };
    
    const importData=(e)=>{
        const r=new FileReader();
        r.onload=(ev)=>{
            try{
                const d=JSON.parse(ev.target.result);
                if(d.itinerary){
                    setData(d.itinerary);
                    if (d.memos) {
                        setMemos(Array.isArray(d.memos) ? d.memos : Object.values(d.memos));
                    } else {
                        setMemos([]);
                    }
                } else if(Array.isArray(d)) {
                     setData(d);
                }
                alert('‚úÖ ËÆÄÂèñÊàêÂäüÔºÅ');setSort(false)
            }catch(err){alert('‚ùå Ê™îÊ°àÈåØË™§');}
        };
        if(e.target.files[0])r.readAsText(e.target.files[0]);
        e.target.value=''
    };

    const calcDur=(s,e)=>{if(!s||!e)return null;const [sh,sm]=s.split(':').map(Number);const [eh,em]=e.split(':').map(Number);const diff=(eh*60+em)-(sh*60+sm);if(diff<0)return{t:'ÈáçÁñä',bad:true};const h=Math.floor(diff/60),m=diff%60;if(h===0&&m===0)return{t:'ÁÑ°Á©∫Ê™î',bad:false};return{t:(h>0?h+'ÊôÇ':'')+(m>0?m+'ÂàÜ':''),bad:false}};
    const gMap=(i)=>`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(i.searchKeyword?.trim()||`${i.title} Êó•Êú¨`)}`;
    const getWeatherUrl = () => { const zip = WEATHER_LOCATIONS[day.id] || '282-0004'; return `https://tenki.jp/search/?keyword=${encodeURIComponent(zip)}`; };
    const getDailyRouteUrl = (items) => {
        const validItems = (items||[]).filter(i => i && i.type !== 'memo');
        return `https://www.google.com/maps/dir/${validItems.map(item => encodeURIComponent(item.searchKeyword?.trim() || item.title)).join('/')}`;
    };

    const toggle=(id)=>{
        const newData=[...data];
        if(!newData[idx] || !newData[idx].items) return;
        const item=newData[idx].items.find(i=>i && i.id===id);
        if(item){
            item.completed=!item.completed;
            setData(newData);
        }
    };
    const toggleNote=(id)=>{const newSet = new Set(expandedNotes);
    if(newSet.has(id)) newSet.delete(id);
    else newSet.add(id); setExpandedNotes(newSet);};

    const handleLedgerClick = (dayId, itemId) => {
        const d = data.find(day => day?.id === dayId);
        if (d && d.items) {
            const item = d.items.find(i => i?.id === itemId);
            if (item) {
                setEditItem({...item, dayId: dayId, originalDayId: dayId});
                setModal(true);
                setLedgerModal(false);
            }
        }
    };

    const saveItem=()=>{
        if (editItem.type === 'memo') {
             if (!editItem.title) {
                 const dateStr = new Date().toLocaleString('zh-TW', { hour12: false, month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                 if (editItem.note) {
                     editItem.title = editItem.note.substring(0, 10) + (editItem.note.length>10?"...":"");
                 } else if (editItem.images && editItem.images.length > 0) {
                     editItem.title = "ÂúñÁâá‰æøÊ¢ù";
                 } else {
                     editItem.title = `Èö®Êâã‰æøÊ¢ù ${dateStr}`;
                 }
             }
        } else {
            if(!editItem.title) return alert('Ë´ãËº∏ÂÖ•Ë°åÁ®ãÊ®ôÈ°å');
        }
        
        if(editItem.type === 'normal' && editItem._h !== undefined && editItem._m !== undefined) { 
            editItem.time = `${editItem._h}:${editItem._m}`;
            delete editItem._h; delete editItem._m;
        }

        const newData=[...data];
        const isMovingDay = editItem.originalDayId && editItem.originalDayId !== editItem.dayId;
        if (isMovingDay) {
            const sourceDay = newData.find(d => d.id === editItem.originalDayId);
            if (sourceDay && sourceDay.items) sourceDay.items = sourceDay.items.filter(x => x && x.id !== editItem.id);
            const targetDay = newData.find(d => d.id === editItem.dayId);
            if (targetDay) {
                if(!targetDay.items) targetDay.items = [];
                targetDay.items.push(editItem);
            }
        } else {
            const targetDay = newData.find(d => d.id === editItem.dayId);
            if (targetDay) {
                if(!targetDay.items) targetDay.items = [];
                const existingIdx = targetDay.items.findIndex(x => x && x.id === editItem.id);
                if (existingIdx > -1) {
                    targetDay.items[existingIdx] = editItem;
                } else {
                    targetDay.items.push(editItem);
                }
            }
        }
        setData(newData);
        setModal(false);
    };
    
    const saveMemo = () => {
        let itemToSave = { ...editMemoItem };
        if (!itemToSave.title.trim()) {
            const dateStr = new Date().toLocaleString('zh-TW', { hour12: false, month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
            itemToSave.title = itemToSave.content.trim() ? (itemToSave.content.substring(0, 10) + (itemToSave.content.length > 10 ? "..." : "")) : `Á≠ÜË®ò ${dateStr}`;
        }
        setMemos(prev => {
            const idx = prev.findIndex(m => m && m.id === itemToSave.id);
            if (idx > -1) {
                const newMemos = [...prev];
                newMemos[idx] = itemToSave;
                return newMemos;
            } else {
                return [...prev, itemToSave];
            }
        });
        setEditMemoItem(null);
    };
    const deleteMemo = (id) => {
        if(confirm('Âà™Èô§Ê≠§Á≠ÜË®ò?')){
            setMemos(prev => prev.filter(m => m.id !== id));
            setEditMemoItem(null);
        }
    };

    const delItem=()=>{
        const newData=[...data];
        const d=newData.find(d=>d.id===editItem.dayId);
        if(d && d.items) {
             d.items=d.items.filter(x=>x && x.id!==editItem.id);
             setData(newData);
        }
        setModal(false);
    };
    const addExpense=()=>{setEditItem({...editItem, expenses: [...(editItem.expenses||[]), {id:Date.now(), label:'', amount:'', currency:'JPY', category: editItem.category || 'other'}]})};
    const updateExpense=(idx, field, val)=>{const newExps=[...editItem.expenses];newExps[idx][field]=val;setEditItem({...editItem, expenses:newExps})};
    const removeExpense=(idx)=>{const newExps=editItem.expenses.filter((_,i)=>i!==idx);setEditItem({...editItem, expenses:newExps})};
    
    const handleImageUpload = (e, isMemo = false) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                let width = img.width;
                let height = img.height;
                const MAX_SIZE = 800;
                if (width > height && width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE;
                }
                else if (height > MAX_SIZE) { width *= MAX_SIZE / height;
                height = MAX_SIZE; }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                if(isMemo) {
                    setEditMemoItem(prev => ({...prev, images: [...(prev.images||[]), {url: dataUrl, text: ''}]}));
                } else {
                    setEditItem(prev => ({...prev, images: [...(prev.images||[]), {url: dataUrl, text: ''}]}));
                }
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    };
    const handleAddUrl = (isMemo = false) => {
        if(urlInputRef.current && urlInputRef.current.value){
            const val = urlInputRef.current.value.trim();
            if(val) {
                 if(isMemo) {
                    setEditMemoItem(prev => ({...prev, images: [...(prev.images||[]), {url: val, text: ''}]}));
                } else {
                    setEditItem(prev => ({...prev, images: [...(prev.images||[]), {url: val, text: ''}]}));
                }
                urlInputRef.current.value = '';
            }
        }
    };
    const handlePaste = useCallback((e, isMemo = false) => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf("image") !== -1) {
                const blob = items[i].getAsFile();
                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        const MAX_SIZE = 800;
                        if (width > height && width > MAX_SIZE) { 
                        height *= MAX_SIZE / width; width = MAX_SIZE; }
                        else if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        if(isMemo) {
                            setEditMemoItem(prev => ({...prev, images: [...(prev.images||[]), {url: dataUrl, text: ''}]}));
                        } else {
                            setEditItem(prev => ({...prev, images: [...(prev.images||[]), {url: dataUrl, text: ''}]}));
                        }
                    }
                    img.src = event.target.result;
                };
                reader.readAsDataURL(blob);
                e.preventDefault(); 
                return;
            }
        }
    }, [editMemoItem, editItem]);

    const moveImg = (e, idx, dir, isMemo = false) => {
        e.stopPropagation();
        const currentItem = isMemo ? editMemoItem : editItem;
        if (!currentItem) return;
        const newImgs = [...currentItem.images];
        const target = idx + dir;
        if(target < 0 || target >= newImgs.length) return;
        [newImgs[idx], newImgs[target]] = [newImgs[target], newImgs[idx]];
        if(isMemo) setEditMemoItem({...editMemoItem, images: newImgs});
        else setEditItem({...editItem, images: newImgs});
    };

    const TimeScroll = ({val, setVal}) => {
        if (!val) return null;
        const parts = val.includes(':') ? val.split(':') : ['12', '00'];
        const h = parts[0];
        const m = parts[1];
        
        return (
            <div className="flex gap-1 items-center bg-slate-50 border border-slate-200 rounded-2xl p-1 h-[64px] shadow-sm">
                <select value={h} onChange={e=>setVal(`${e.target.value}:${m}`)} className="appearance-none bg-transparent text-xl font-black text-center w-full outline-none text-slate-700">
                    {Array.from({length:24},(_,i)=>i.toString().padStart(2,'0')).map(v=><option key={v} value={v}>{v}</option>)}
                </select>
                <span className="text-slate-300 font-black mb-1">:</span>
                <select value={m} onChange={e=>setVal(`${h}:${e.target.value}`)} className="appearance-none bg-transparent text-xl font-black text-center w-full outline-none text-slate-700">
                    {Array.from({length:12},(_,i)=>(i*5).toString().padStart(2,'0')).map(v=><option key={v} value={v}>{v}</option>)}
                </select>
            </div>
        );
    };

    return (
        <div className={`h-[100dvh] flex flex-col font-sans text-slate-800 bg-[#fff7ed] ${sort ? 'sort-mode-bg' : ''}`}>
            <div className="bg-gradient-to-r from-rose-500 to-orange-400 shadow-md pt-safe z-30 shrink-0 relative">
                <div className="h-1.5 w-full bg-black/10 absolute top-0 left-0"><div className="h-full bg-yellow-300 transition-all duration-500" style={{width:`${((idx+1)/data.length)*100}%`}}/></div>
                <div className="px-4 py-3 text-white">
                    <div className="flex justify-between items-end">
                        <div className="flex flex-col justify-center">
                            <div className="flex items-center gap-2 relative">
                                <span className="text-base font-bold text-white/80 absolute -top-4 left-0.5">{day.date.startsWith('12') ? '2025' : '2026'}</span>
                                <h1 className="font-black text-5xl tracking-wide leading-none drop-shadow-md mt-1">{day.date}</h1>
                                <span className="text-xl font-bold opacity-90 self-end mb-1">{day.dayOfWeek}</span>
                             </div>
                            <div className="text-sm font-bold text-white flex items-center gap-1 mt-1 drop-shadow-sm"><Icon n="MapPin" s={14} c="shrink-0 text-yellow-200"/><span className="truncate max-w-[220px] leading-none">{day.location}</span></div>
                        </div>
                        <div className="flex flex-col items-end gap-2">
                            <a href={getWeatherUrl()} target="_blank" className="flex flex-col items-end gap-0.5 bg-white/10 px-2 py-1 rounded-lg backdrop-blur-md border border-white/20 shadow-md cursor-pointer relative active:scale-95 transition-transform">
                                <div className="flex items-center gap-1">
                                    <div className={`${weatherColorClass} ${weatherAnimClass}`}>
                                        <Icon n={weatherIconName} s={24} />
                                    </div>
                                    <span className="font-bold text-2xl text-white drop-shadow-sm">
                                        {liveWeather ? `${liveWeather.temp}¬∞` : '...'}
                                    </span>
                                </div>
                                <span className="text-[9px] font-bold text-yellow-100 opacity-80">
                                    {liveWeather ? 'ÁõÆÂâçÂ§©Ê∞£' : 'ËÆÄÂèñ‰∏≠'}
                                </span>
                            </a>
                            <button onClick={()=>{setTStep(day.steps||'');setStepModal(true)}} className="flex items-center gap-1 text-xs text-rose-600 font-black bg-white px-3 py-1 rounded-full shadow-lg active:scale-95 transition-transform border border-rose-100">
                                <Icon n="Footprints" s={14}/><span className={`leading-none pt-0.5 ${Number(day.steps) > 0 ? 'text-rose-600' : 'text-slate-400'}`}>{displaySteps.toLocaleString()}</span>
                            </button>
                        </div>
                    </div>
                    
                    <div className={`flex gap-1 hide-scrollbar py-4 px-2 overflow-x-auto mt-1 scroll-smooth-mobile ${sort?'opacity-30 pointer-events-none':''}`}>
                        {data.map((d,i)=>{
                            if(!d) return null;
                            return (
                                <button key={d.id} onClick={()=>{setIdx(i);setSort(false); scrollRef.current?.scrollTo({ top: 0, behavior: 'smooth' });}} className={`flex-shrink-0 rounded-full transition-all shadow-none tap-transparent sakura-btn-container ${idx===i?'sakura-active':''}`}>
                                    {idx===i ? (<div className="sakura-icon-active text-rose-200"><Icon n="Sakura" s={54} c="w-full h-full"/></div>) : (<div className="sakura-icon-inactive text-white"><Icon n="Sakura" s={46} c="w-full h-full"/></div>)}
                                    <span className={idx===i ? 'sakura-text-active' : 'sakura-text-inactive'}>D{i+1}</span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            </div>

            <div ref={scrollRef} className={`flex-1 overflow-y-auto relative scroll-smooth-mobile -mt-2 pt-4`}>
                <div className="py-2 pb-32 space-y-6">
                    {!sort && liveWeather && (getWeatherTypeFromCode(liveWeather.code) === 'snow' || getWeatherTypeFromCode(liveWeather.code) === 'rain') && (
                        <div className={`mx-4 border-2 rounded-3xl p-3 shadow-sm flex items-center gap-3 mb-4 animate-fade-in ${getWeatherTypeFromCode(liveWeather.code) === 'snow' ? 'bg-gradient-to-r from-cyan-50 to-blue-50 border-cyan-200' : 'bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200'}`}>
                            <div className={getWeatherTypeFromCode(liveWeather.code) === 'snow' ? 'text-cyan-500' : 'text-blue-500'}>
                                 <Icon n={getWeatherTypeFromCode(liveWeather.code) === 'snow' ? 'CloudSnow' : 'CloudRain'} s={24}/>
                            </div>
                            <div className="flex-1">
                                <div className={`font-bold text-sm ${getWeatherTypeFromCode(liveWeather.code) === 'snow' ? 'text-cyan-800' : 'text-blue-800'}`}>
                                    {getWeatherTypeFromCode(liveWeather.code) === 'snow' ? '‚ùÑÔ∏è ÁõÆÂâçÊúâÈõ™ÔΩúÂª∫Ë≠∞ÂÇôÂ¶•Èõ™Èçä' : 'üåßÔ∏è ÁõÆÂâçÊúâÈõ®ÔΩúÂ§©Èõ®Ë∑ØÊªëË´ãÂ∞èÂøÉ'}
                                </div>
                                <a href={getWeatherUrl()} target="_blank" className={`text-[10px] font-bold underline mt-0.5 block ${getWeatherTypeFromCode(liveWeather.code) === 'snow' ? 'text-cyan-500' : 'text-blue-500'}`}>ÈªûÊ≠§Á¢∫Ë™çÁï∂Âú∞Â§©Ê∞£È†êÂ†± ></a>
                            </div>
                        </div>
                    )}
                    
                    <div ref={sortableRef} className="relative">
                        {!sort && <div className="absolute left-[24px] top-4 bottom-4 w-[3px] bg-slate-300 rounded-full z-0"/>}
                        
                        {(day.items || []).map((item,i)=>{
                            if (!item) return null;
                            const cat=CATS[item.category] || CATS.other;
                            const isMemo = item.type === 'memo';
                            const next=day.items[i+1];
                            const dur=(!isMemo && next && next.type !== 'memo') ? calcDur(item.time,next.time) : null;
                            const totalItemJPY = (item.expenses || []).filter(e=>e.currency!=='NT').reduce((s,x)=>s+Number(x.amount||0),0);
                            const totalItemNT = (item.expenses || []).filter(e=>e.currency==='NT').reduce((s,x)=>s+Number(x.amount||0),0);
                            const isExpanded = expandedNotes.has(item.id);
                            
                            // Memo Card
                            if (isMemo) {
                                return (
                                     <div key={item.id} className={`relative ${sort?'mb-3 px-4':'mb-4 pl-12 pr-6'}`} onTouchStart={startLongPress} onTouchMove={endLongPress} onTouchEnd={endLongPress} onMouseDown={startLongPress} onMouseUp={endLongPress} onMouseLeave={endLongPress}>
                                        {!sort && (
                                            <>
                                                <div className="absolute right-0 top-0 z-20">
                                                     <button onClick={(e)=>{e.stopPropagation();setEditItem({...item, dayId: day.id, originalDayId: day.id});setModal(true)}} className="w-8 h-8 bg-yellow-50 rounded-full flex items-center justify-center shadow-sm border border-yellow-200 text-yellow-600 active:scale-90 transition-transform"><Icon n="Edit" s={14}/></button>
                                                </div>
                                                <div className="absolute left-1 top-4 w-8 h-8 rounded-full z-20 flex items-center justify-center bg-yellow-100 text-yellow-600 border-2 border-[#fff7ed] shadow-sm">
                                                    <Icon n="StickyNote" s={14}/>
                                                 </div>
                                            </>
                                         )}
                                        <div onClick={()=>!sort && toggleNote(item.id)} className={`bg-yellow-50 rounded-xl border border-yellow-200 relative z-10 transition-all tap-transparent ${sort?'p-2 border-yellow-400 border-2 shadow-lg':'p-3 card-shadow'}`}>
                                            {sort ? (
                                                 <div className="flex items-center gap-3">
                                                     <div className="drag-handle w-8 flex items-center justify-center flex-shrink-0 text-yellow-400"><Icon n="DragHandle" s={20}/></div>
                                                    <div className="font-bold text-slate-800 text-sm line-clamp-1">{item.title}</div>
                                                 </div>
                                            ) : (
                                                <div className="flex flex-col gap-2">
                                                    <h3 className="font-bold text-slate-800 text-base leading-snug">{item.title}</h3>
                                                    {item.note && <div className="text-sm text-slate-600 whitespace-pre-wrap leading-relaxed"><Linkify text={item.note}/></div>}
                                                    {item.images && item.images.length > 0 && (
                                                         <div className="memo-grid mt-2">
                                                             {item.images.map((img, idx) => (
                                                                <div key={idx} className="aspect-square rounded-lg overflow-hidden border border-yellow-100 bg-white" onClick={(e)=>{e.stopPropagation(); setEditItem(item); setViewImgIdx(idx);}}>
                                                                    <img src={typeof img === 'string' ? img : img.url} className="w-full h-full object-cover"/>
                                                                </div>
                                                              ))}
                                                        </div>
                                                     )}
                                                </div>
                                             )}
                                        </div>
                                     </div>
                                );
                            }

                            // Standard Itinerary Card
                            return (
                                <div key={item.id} className={`relative ${sort?'mb-3 px-4':'mb-8 pl-16 pr-6'}`} onTouchStart={startLongPress} onTouchMove={endLongPress} onTouchEnd={endLongPress} onMouseDown={startLongPress} onMouseUp={endLongPress} onMouseLeave={endLongPress}>
                                    {!sort && (
                                        <>
                                             <div className="absolute right-0 top-0 z-20">
                                                <button onClick={(e)=>{e.stopPropagation();setEditItem({...item, dayId: day.id, originalDayId: day.id});setModal(true)}} className="w-9 h-9 bg-blue-50 rounded-full flex items-center justify-center shadow-sm border border-blue-100 text-blue-500 active:scale-90 transition-transform">
                                                    <Icon n="Edit" s={18}/>
                                                </button>
                                             </div>

                                            <div onClick={(e)=>{e.stopPropagation();toggle(item.id)}} className={`absolute left-0 top-0 w-12 h-12 rounded-full border-[4px] border-[#fff7ed] z-20 flex items-center justify-center transition-all shadow-md cursor-pointer ${item.completed?'bg-emerald-500 text-white scale-90':'bg-white text-slate-400 ' + cat.c.replace('bg-', 'text-').replace('text-', 'border-')} ring-1 ring-slate-100`}>
                                                <div className={`w-full h-full rounded-full flex items-center justify-center ${!item.completed && cat.c}`}>
                                                     {item.completed ? <Icon n="Check" s={24}/> : <Icon n={cat.i} s={20}/>}
                                                </div>
                                            </div>
                                            {dur && <div className="absolute left-[6px] -bottom-6 z-10 flex flex-col items-center w-10 pointer-events-none"><div className="bg-white border border-slate-200 rounded-full px-1.5 py-0.5 text-[9px] text-slate-400 font-bold shadow-sm whitespace-nowrap flex items-center gap-1"><Icon n="Clock" s={10}/>{dur.t}</div></div>}
                                         </>
                                    )}

                                    <div 
                                        onClick={()=>!sort && toggleNote(item.id)} 
                                        className={`bg-white rounded-2xl border border-slate-100 relative z-10 transition-all tap-transparent ${sort?'p-0 border-blue-400 border-2 shadow-lg flex items-stretch bg-blue-50/20 overflow-hidden':'p-4 hover:shadow-lg active:scale-[0.98] card-shadow '+(item.completed?'bg-slate-50/80 grayscale-[0.5]':'')}`}
                                         >
                                        {sort?(
                                            <>
                                                <div className="drag-handle w-14 bg-slate-100 flex items-center justify-center flex-shrink-0 border-r border-slate-200 cursor-grab active:cursor-grabbing touch-none">
                                                     <Icon n="DragHandle" s={24} c="text-slate-400"/>
                                                </div>
                                                <div className="flex-1 p-3 pointer-events-none select-none flex flex-col justify-center min-w-0">
                                                    <div className="text-xs font-bold text-blue-600 mb-0.5">{item.time}</div>
                                                    <div className="font-bold text-slate-800 text-base line-clamp-1">{item.title}</div>
                                                </div>
                                            </>
                                        ):(
                                            <div className="relative flex flex-col gap-2">
                                                <div className="flex justify-between items-start pr-10"> 
                                                     <div className="flex items-baseline gap-2">
                                                        <span className="text-xl font-black text-slate-800 font-mono tracking-tight">{item.time}</span>
                                                        <span className={`text-[10px] px-2 py-0.5 rounded-full font-bold border ${cat.c.replace('text-','border-').replace('100','200')}`}>{cat.l}</span>
                                                    </div>
                                                </div>
                                                <h3 className={`font-black text-lg leading-snug font-rounded flex items-start gap-1 ${item.completed?'text-slate-400 line-through decoration-slate-300':'text-slate-800'}`}>
                                                    {item.title}
                                                </h3>
                                                <div className={`note-expand ${isExpanded || (item.note && isExpanded) ? 'open' : ''} ${!isExpanded && item.note ? 'max-h-0 opacity-0' : ''}`}>{item.note && (<div onClick={(e)=>{e.stopPropagation(); toggleNote(item.id)}} className="cursor-pointer text-sm font-medium text-slate-600 bg-yellow-50 p-3 rounded-lg border-l-4 border-yellow-400 leading-relaxed whitespace-pre-line active:bg-yellow-100 transition-colors"><Linkify text={item.note}/></div>)}</div>
                                                {!isExpanded && item.note && <div onClick={()=>toggleNote(item.id)} className="text-[10px] text-slate-400 text-center cursor-pointer hover:text-blue-500 font-bold">üìù ÈªûÊìäÊü•ÁúãÂÇôË®ª...</div>}
                                                 
                                                <div className="mt-2 pt-2 border-t border-slate-50 flex justify-between items-center">
                                                    <div className="flex flex-wrap gap-x-3 gap-y-1 text-[10px] font-bold text-slate-500 items-center">
                                                        {(totalItemJPY > 0 || totalItemNT > 0) && (
                                                            <div className="flex items-center gap-1 text-slate-600">
                                                                <Icon n="DollarSign" s={12}/>
                                                                <span>{totalItemJPY > 0 ? `¬•${fmtMoney(totalItemJPY)}` : ''} {totalItemNT > 0 ? `NT${fmtMoney(totalItemNT)}` : ''}</span>
                                                            </div>
                                                         )}
                                                        {item.steps > 0 && (
                                                            <div className="flex items-center gap-1 text-pink-500">
                                                                <Icon n="Footprints" s={12}/>
                                                                <span>{Number(item.steps).toLocaleString()}</span>
                                                            </div>
                                                        )}
                                                        {item.mapcode && (
                                                            <div className="flex items-center gap-1 bg-slate-100 px-1.5 py-0.5 rounded text-slate-400 font-mono">
                                                                MC: {item.mapcode}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <a href={gMap(item)} target="_blank" onClick={e=>e.stopPropagation()} className="w-8 h-8 flex items-center justify-center bg-blue-50 text-blue-500 rounded-full active:scale-90 transition-transform shadow-sm border border-blue-100">
                                                        <Icon n="Navigation" s={16}/>
                                                     </a>
                                                </div>
                                             </div>
                                        )}
                                    </div>
                                 </div>
                            );
                        })}
                    </div>
                    {!sort && <div className="mt-6 mb-4 flex justify-center"><a href={getDailyRouteUrl(day.items)} target="_blank" className="bg-gradient-to-r from-emerald-500 to-teal-600 text-white px-8 py-4 rounded-full shadow-lg font-bold text-base flex items-center gap-2 active:scale-95 transition-transform hover:shadow-xl border-2 border-white/50"><Icon n="Route" s={22}/> üöó Êü•Áúã‰ªäÊó•Á∏ΩË∑ØÁ∑ö</a></div>}
                </div>
            </div>

            <div className={`fixed bottom-0 w-full z-50 transition-transform duration-300 ${(footerExpanded || sort) ? 'translate-y-0' : 'translate-y-full'}`}>
                {!sort && (
                    <div 
                        onClick={() => setFooterExpanded(!footerExpanded)} 
                        className="absolute left-1/2 -translate-x-1/2 -top-6 w-12 h-6 bg-white/90 backdrop-blur-sm rounded-t-full shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] border-t border-x border-slate-200 flex items-center justify-center cursor-pointer"
                    >
                        <div className={`text-slate-400 transition-transform duration-300 ${footerExpanded ? 'rotate-180' : ''}`}>
                            <Icon n="ChevronUp" s={20}/>
                         </div>
                    </div>
                )}

                {sort ? (
                    <div className="bg-white/90 backdrop-blur-md border-t border-slate-200 shadow-[0_-4px_20px_rgba(0,0,0,0.15)] pb-safe p-4 flex justify-between gap-4 animate-fade-in">
                        <button onClick={cancelSort} className="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-2xl flex items-center justify-center gap-2 active:scale-95"><Icon n="X" s={20}/> ÂèñÊ∂à</button>
                        <button onClick={finishSort} className="flex-[2] bg-blue-500 text-white font-bold py-3 rounded-2xl flex items-center justify-center gap-2 shadow-lg shadow-blue-200 active:scale-95"><Icon n="Check" s={20}/> ÂÆåÊàêÊéíÂ∫è</button>
                    </div>
                ) : (
                    <div className="bg-white border-t border-slate-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] pb-safe">
                        <div className="px-4 py-3 flex items-center justify-between gap-4">
                            <div className="flex flex-col min-w-0">
                                <div className="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-0.5">Ë°åÁ®ãÁ∏ΩÊîØÂá∫</div>
                                <div className="flex flex-wrap items-baseline gap-x-2">
                                    <span className="font-black text-slate-800 text-xl">NT${fmtMoney(totalNT)}</span>
                                    <span className="font-bold text-slate-500 text-sm">¬•{fmtMoney(totalJPY)}</span>
                                 </div>
                            </div>
                            <div className="flex gap-2 shrink-0">
                                <button onClick={()=>setNotebookModal(true)} className="p-3 bg-yellow-50 text-yellow-600 rounded-xl active:scale-90 transition-transform mr-2"><Icon n="Book" s={20}/></button>
                                
                                <button onClick={()=>{setFilterCategory(null); setLedgerModal(true)}} className="p-3 bg-blue-50 text-blue-600 rounded-xl active:scale-90 transition-transform"><Icon n="Wallet" s={20}/></button>
                                
                                <div className="relative">
                                    <button onClick={()=>setAddMenuOpen(!addMenuOpen)} className="p-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl shadow-md active:scale-90 transition-transform"><Icon n="Plus" s={20}/></button>
                                    {addMenuOpen && (
                                        <>
                                            <div className="fixed inset-0 z-40" onClick={()=>setAddMenuOpen(false)}></div>
                                            <div className="absolute bottom-full right-0 mb-2 w-40 bg-white rounded-xl shadow-xl border border-slate-100 p-1 z-50 animate-fade-in flex flex-col gap-1">
                                                <button onClick={()=>{setAddMenuOpen(false); setEditItem({id:Date.now().toString(),time:'12:00',title:'',category:'sightseeing',expenses:[],note:'',mapcode:'',searchKeyword:'',completed:false,dayId:day.id,originalDayId:day.id,steps:0,type:'normal'});setModal(true)}} className="text-left px-4 py-3 text-sm font-bold text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                                    <span className="text-blue-500"><Icon n="MapPin" s={18}/></span> Êñ∞Â¢ûË°åÁ®ã
                                                 </button>
                                                <button onClick={()=>{setAddMenuOpen(false); setEditItem({id:Date.now().toString(),title:'',note:'',images:[],dayId:day.id,originalDayId:day.id,type:'memo', category: 'memo'});setModal(true)}} className="text-left px-4 py-3 text-sm font-bold text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2">
                                                    <span className="text-yellow-500"><Icon n="StickyNote" s={18}/></span> Êñ∞Â¢û‰æøÊ¢ù
                                                 </button>
                                            </div>
                                        </>
                                    )}
                                </div>

                                <div className="w-[1px] h-8 bg-slate-100 mx-1"></div>
                                <div className="relative group">
                                    <button className={`p-3 rounded-xl active:scale-90 transition-transform ${menuOpen ? 'bg-slate-200 text-slate-800' : 'bg-slate-50 text-slate-500'}`} onClick={() => setMenuOpen(!menuOpen)}>
                                        <Icon n="Menu" s={20}/>
                                    </button>
                                     {menuOpen && (
                                        <>
                                             <div className="fixed inset-0 z-40" onClick={() => setMenuOpen(false)}></div>
                                            <div className="absolute bottom-full right-0 mb-2 w-36 bg-white rounded-xl shadow-2xl border border-slate-100 p-1 z-50 animate-fade-in">
                                                 <button onClick={() => { exportData(); setMenuOpen(false); }} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2"><Icon n="Download" s={16}/> ÂÇô‰ªΩË≥áÊñô</button>
                                                <button onClick={() => { fileRef.current.click(); setMenuOpen(false); }} className="w-full text-left px-4 py-3 text-sm font-bold text-slate-600 hover:bg-slate-50 rounded-lg flex items-center gap-2"><Icon n="Upload" s={16}/> ËÆÄÂèñÂÇô‰ªΩ</button>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                         </div>
                        <div className="text-[10px] text-slate-300 mt-2 text-center">App Version: 40.0 (Ultimate Stable)</div>
                    </div>
                )}
            </div>
            
            <input type="file" ref={fileRef} onChange={importData} accept=".json" className="hidden"/>

            {/* Ledger Modal */}
            {ledgerModal && <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center animate-fade-in">
                <div className="bg-white w-full sm:w-[95%] max-w-lg rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[85vh] h-[85vh]">
                    <div className="px-6 py-5 border-b flex justify-between items-center bg-blue-50 rounded-t-3xl"><h2 className="font-bold text-xl text-blue-600 flex items-center gap-2"><Icon n="Wallet" s={24}/> ÊóÖÈÅäÂ∏≥Êú¨</h2><button onClick={()=>setLedgerModal(false)} className="p-2 bg-white rounded-full shadow-sm text-slate-500"><Icon n="X" s={20}/></button></div>
                    <div className="p-6 overflow-y-auto flex-1 space-y-6">
                        <div className="grid grid-cols-1 gap-4"> 
                             <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg"><div className="text-xs font-bold opacity-80 mb-1">Á∏ΩÊîØÂá∫ (NT)</div><div className="text-2xl font-black font-mono">NT${fmtMoney(totalNT)}</div></div>
                            <div className="bg-gradient-to-br from-orange-400 to-orange-500 rounded-2xl p-4 text-white shadow-lg"><div className="text-xs font-bold opacity-80 mb-1">Á∏ΩÊîØÂá∫ (JPY)</div><div className="text-2xl font-black font-mono">¬•{fmtMoney(totalJPY)}</div></div>
                         </div>
                        <div>
                            <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-slate-700 text-lg">ÂàÜÈ°ûÁµ±Ë®à <span className="text-xs text-slate-400 font-normal ml-2">(ÈªûÊìäÁØ©ÈÅ∏)</span></h3>{filterCategory && <button onClick={()=>setFilterCategory(null)} className="text-xs text-pink-500 font-bold bg-pink-50 px-2 py-1 rounded-lg">Ê∏ÖÈô§ÁØ©ÈÅ∏</button>}</div>
                             <div className="space-y-3">{Object.entries(expensesByCategory).map(([key, val]) => (val.nt > 0 || val.jpy > 0) && (<div key={key} onClick={() => setFilterCategory(filterCategory === key ? null : key)} className={`rounded-xl p-3 border transition-all cursor-pointer active:scale-95 ${filterCategory === key ? 'bg-pink-50 border-pink-300 ring-2 ring-pink-200 shadow-md' : 'bg-slate-50 border-slate-100 hover:bg-slate-100'}`}><div className="flex justify-between items-center mb-2"><div className="flex items-center gap-2"><div className={`w-8 h-8 rounded-full flex items-center justify-center ${val.color.replace('text-', 'bg-').split(' ')[0]} text-white shadow-sm`}><Icon n={CATS[key]?.i || 'DollarSign'} s={16}/></div><span className={`font-bold ${filterCategory === key ? 'text-pink-700' : 'text-slate-700'}`}>{val.label}</span></div>{filterCategory === key && <div className="text-pink-500"><Icon n="Check" s={16}/></div>}</div><div className="flex justify-end gap-4 text-sm font-mono font-bold text-slate-600">{val.nt > 0 && <span>NT$ {fmtMoney(val.nt)}</span>}{val.jpy > 0 && <span>¬• {fmtMoney(val.jpy)}</span>}</div></div>))}</div>
                         </div>
                        <div><h3 className="font-bold text-slate-700 mb-3 text-lg flex items-center gap-2">{filterCategory ? <><span className="text-pink-500"><Icon n={CATS[filterCategory]?.i} s={20}/></span> {CATS[filterCategory]?.l}ÊòéÁ¥∞</> : 'ÊâÄÊúâÊ∂àË≤ªÊòéÁ¥∞'}</h3><div className="space-y-2">{displayedExpenses.length > 0 ? displayedExpenses.map((ex, i) => (<div key={i} onClick={() => handleLedgerClick(ex.dayId, ex.itemId)} className="flex justify-between items-center p-3 border-b border-slate-100 last:border-0 animate-fade-in cursor-pointer hover:bg-slate-50 active:bg-slate-100 transition-colors rounded-lg"><div className="flex-1"><div className="text-xs text-slate-400 mb-0.5">{ex.date} {ex.time} ¬∑ {CATS[ex.category]?.l || 'ÂÖ∂‰ªñ'}</div><div className="font-bold text-slate-800 text-sm line-clamp-1">{ex.title}</div><div className="text-xs text-slate-500 mt-0.5">{ex.label}</div></div><div className="font-mono font-bold text-slate-700 text-right"><span className="text-xs text-slate-400 mr-1">{ex.currency}</span>{fmtMoney(ex.amount)}</div></div>)) : <div className="text-center py-8 text-slate-400 text-sm">Ê≠§ÂàÜÈ°ûÂ∞öÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>}</div></div>
                    </div>
                </div>
            </div>}
            
            {/* Independent Notebook Modal (Stabilized) */}
            {notebookModal && (
                <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center animate-fade-in">
                    <div className="bg-white w-full sm:w-[95%] max-w-lg rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[95vh] h-[95vh]">
                        <div className="px-6 py-5 border-b flex justify-between items-center bg-yellow-50 rounded-t-3xl">
                            <h2 className="font-bold text-xl text-yellow-600 flex items-center gap-2"><Icon n="Book" s={24}/> Èö®Ë∫´Á≠ÜË®òÊú¨</h2>
                            {memoSort ? (
                                <button onClick={() => setMemoSort(false)} className="bg-blue-500 text-white px-6 py-2 rounded-full font-bold shadow-lg transition-transform active:scale-95 flex items-center gap-2">
                                    <Icon n="Check" s={18}/> ÂÆåÊàê
                                 </button>
                            ) : (
                                <div className="flex gap-2">
                                     <button onClick={() => setMemoSort(true)} className="p-2 bg-yellow-100 text-yellow-600 rounded-full active:scale-90 transition-transform"><Icon n="Sort" s={20}/></button>
                                    {!editMemoItem && <button onClick={()=>setEditMemoItem({id:Date.now().toString(), title:'', content:'', images:[]})} className="bg-yellow-500 text-white px-3 py-1.5 rounded-full text-xs font-bold shadow-sm active:scale-95">+ Êñ∞Â¢û</button>}
                                     <button onClick={()=>{setNotebookModal(false); setEditMemoItem(null); setMemoSort(false)}} className="p-2 bg-white rounded-full shadow-sm text-slate-500"><Icon n="X" s={20}/></button>
                                </div>
                            )}
                        </div>
                        <div className="p-4 flex-1 flex flex-col bg-slate-50 overflow-y-auto">
                            {editMemoItem ? (
                                <div className="space-y-4 animate-fade-in" onPaste={(e)=>handlePaste(e, true)}>
                                    <input type="text" value={editMemoItem.title} onChange={e=>setEditMemoItem({...editMemoItem, title:e.target.value})} placeholder="Á≠ÜË®òÊ®ôÈ°å (‰æãÂ¶Ç: ÂøÖË≤∑Ê∏ÖÂñÆ)" className="w-full bg-white p-4 rounded-2xl font-bold text-lg border-2 border-yellow-100 outline-none focus:border-yellow-400"/>
                                     <textarea value={editMemoItem.content} onChange={e=>setEditMemoItem({...editMemoItem, content:e.target.value})} placeholder="Ëº∏ÂÖ•Ë©≥Á¥∞ÂÖßÂÆπ... (ÊîØÊè¥Áõ¥Êé•Ë≤º‰∏äÂúñÁâá)" className="w-full bg-white p-4 rounded-2xl text-base border-2 border-slate-100 outline-none focus:border-yellow-400 h-40"/>
                                    
                                     <div>
                                        <div className="text-sm font-bold text-slate-500 mb-2">ÂúñÁâá (‰∏äÂÇ≥/Ë≤ºÈÄ£Áµê)</div>
                                        <div className="flex gap-2 mb-2">
                                            <input ref={urlInputRef} type="text" placeholder="Ë≤º‰∏äÂúñÁâáÁ∂≤ÂùÄ..." className="flex-1 bg-white px-3 py-2 rounded-xl text-sm border border-slate-200 outline-none focus:border-yellow-400"/>
                                            <button onClick={()=>handleAddUrl(true)} className="bg-yellow-100 text-yellow-600 p-2.5 rounded-xl border border-yellow-200 active:scale-95 flex items-center justify-center"><Icon n="Plus" s={20}/></button>
                                            
                                            <button onClick={()=>imgInputRef.current.click()} className="bg-slate-200 text-slate-600 px-3 py-2 rounded-xl text-sm font-bold active:scale-95 flex items-center gap-1"><Icon n="Image" s={18}/></button>
                                            <input type="file" ref={imgInputRef} className="hidden" accept="image/*" onChange={(e)=>handleImageUpload(e, true)}/>
                                        </div>
                                        <div className="grid grid-cols-3 gap-2">
                                            {(editMemoItem.images || []).map((imgItem, i) => {
                                                const imgSrc = typeof imgItem === 'string' ? imgItem : imgItem.url;
                                                 return (
                                                    <div key={i} className="relative aspect-square rounded-xl overflow-hidden border-2 border-slate-200 bg-white group shadow-sm">
                                                         <img src={imgSrc} onClick={()=>setViewImgIdx(i)} className="w-full h-full object-cover cursor-zoom-in"/>
                                                        <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-between p-1 z-20 pointer-events-none">
                                                            <button onClick={(e)=>{e.stopPropagation(); setEditMemoItem({...editMemoItem, images: editMemoItem.images.filter((_, idx)=>idx!==i)})}} className="self-end text-white bg-red-500/80 rounded-full p-1 hover:bg-red-600 pointer-events-auto"><Icon n="X" s={14}/></button>
                                                            <div className="flex justify-between w-full pointer-events-auto">
                                                                {i > 0 && <button onClick={(e)=>moveImg(e, i, -1, true)} className="text-white bg-slate-500/80 rounded-full p-1 hover:bg-slate-600"><Icon n="ChevronLeft" s={14}/></button>}
                                                                {i < editMemoItem.images.length - 1 && <button onClick={(e)=>moveImg(e, i, 1, true)} className="text-white bg-slate-500/80 rounded-full p-1 ml-auto hover:bg-slate-600"><Icon n="ChevronRight" s={14}/></button>}
                                                            </div>
                                                         </div>
                                                    </div>
                                                 );
                                            })}
                                        </div>
                                    </div>
                                     
                                    <div className="flex gap-3 pt-4">
                                         {memos.find(m=>m.id===editMemoItem.id) && <button onClick={(e)=>{e.stopPropagation(); deleteMemo(editMemoItem.id);}} className="p-4 rounded-2xl bg-red-50 text-red-500 font-bold"><Icon n="Trash2" s={20}/></button>}
                                         <button onClick={()=>{setEditMemoItem(null)}} className="p-4 rounded-2xl bg-slate-100 text-slate-500 font-bold">ÊîæÊ£Ñ</button>
                                         <button onClick={saveMemo} className="flex-1 bg-yellow-500 text-white rounded-2xl py-4 font-bold text-lg shadow-lg shadow-yellow-200 active:scale-95">ÂÑ≤Â≠òÁ≠ÜË®ò</button>
                                    </div>
                                </div>
                            ) : (
                                <>
                                    {memos.length === 0 && <div className="text-center py-10 text-slate-400">Â∞öÁÑ°Á≠ÜË®òÔºåÈªûÊìäÂè≥‰∏äËßíÊñ∞Â¢ûÔºÅ</div>}
                                    {memoSort && <div className="text-center text-xs font-bold text-yellow-600 mb-2">ÊãñÊõ≥‰∏ãÊñπÊääÊâãÈÄ≤Ë°åÊéíÂ∫è</div>}
                                    
                                    <div className="space-y-3 relative" ref={memoSortableRef}>
                                        {memos.map(memo => {
                                            if(!memo) return null;
                                            return (
                                                <div key={memo.id} className={`bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex gap-4 ${memoSort ? 'mb-2 border-yellow-400 border-2 no-scale-anim' : 'active:scale-98 transition-transform'}`} onClick={()=>!memoSort && setEditMemoItem(memo)}>
                                                    {memoSort && <div className="drag-handle-memo flex items-center justify-center text-slate-300 pr-2 cursor-grab"><Icon n="DragHandle" s={20}/></div>}
                                                    {memo.images && memo.images.length > 0 && (
                                                        <div className="w-20 h-20 shrink-0 rounded-xl overflow-hidden bg-slate-100 relative border border-slate-100">
                                                            <img src={typeof memo.images[0] === 'string' ? memo.images[0] : memo.images[0].url} className="w-full h-full object-cover"/>
                                                        </div>
                                                    )}
                                                    <div className="flex-1 min-w-0">
                                                        <h3 className="font-bold text-slate-800 mb-1 line-clamp-1 text-lg">{memo.title}</h3>
                                                        <p className="text-sm text-slate-500 line-clamp-2"><Linkify text={memo.content}/></p>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </>
                            )}
                        </div>
                    </div>
                </div>
            )}

            {/* Lightbox for both Normal & Memo */}
            {viewImgIdx !== null && (editItem || editMemoItem) && (
                <div className="fixed inset-0 z-[120] bg-black/95 flex flex-col items-center justify-center p-4 animate-fade-in" onClick={()=>setViewImgIdx(null)}>
                    <button onClick={()=>setViewImgIdx(null)} className="absolute top-6 right-6 text-white/80 hover:text-white bg-white/10 rounded-full p-2 backdrop-blur-sm z-50"><Icon n="X" s={24}/></button>
                    <div className="flex-1 w-full flex items-center justify-center min-h-0 py-4" onClick={e=>e.stopPropagation()}>
                         <img 
                            src={
                                (editMemoItem 
                                     ? (typeof editMemoItem.images[viewImgIdx] === 'string' ? editMemoItem.images[viewImgIdx] : editMemoItem.images[viewImgIdx].url)
                                    : (typeof editItem.images[viewImgIdx] === 'string' ? editItem.images[viewImgIdx] : editItem.images[viewImgIdx].url)
                                )
                             } 
                            className="max-w-full max-h-full object-contain rounded-lg shadow-2xl cursor-default" 
                        />
                     </div>
                    <div className={`w-full max-w-lg bg-white transition-all duration-300 ease-out ${showLargeInput ? 'h-[50vh] rounded-t-3xl rounded-b-none' : 'rounded-2xl h-auto'} p-3 flex flex-col gap-2 shrink-0 mb-safe shadow-xl z-50`} onClick={e=>e.stopPropagation()}>
                        <div className="flex gap-3 items-start h-full">
                             <div className="text-slate-400 mt-2 shrink-0"><Icon n="Edit" s={20}/></div>
                              <textarea 
                                placeholder="Ëº∏ÂÖ•ÂúñÁâáÂÇôË®ª (‰æãÂ¶Ç: ÂøÖË≤∑Ëó•Â¶ù)..."
                                value={
                                     editMemoItem 
                                    ? (typeof editMemoItem.images[viewImgIdx] === 'string' ? '' : (editMemoItem.images[viewImgIdx].text || ''))
                                    : (typeof editItem.images[viewImgIdx] === 'string' ? '' : (editItem.images[viewImgIdx].text || ''))
                                }
                                 onChange={(e)=>{
                                    const isMemo = !!editMemoItem;
                                    const currentItem = isMemo ? editMemoItem : editItem;
                                    const newImgs = [...currentItem.images];
                                    const imgObj = newImgs[viewImgIdx];
                                    const url = typeof imgObj === 'string' ? imgObj : imgObj.url;
                                    newImgs[viewImgIdx] = { url: url, text: e.target.value };
                                    if(isMemo) setEditMemoItem({...editMemoItem, images: newImgs});
                                    else setEditItem({...editItem, images: newImgs});
                                }}
                                className={`flex-1 bg-transparent text-slate-800 font-bold text-sm outline-none resize-none leading-relaxed transition-all ${showLargeInput ? 'h-full p-2' : 'h-10 py-2'}`}
                            />
                            <button onClick={()=>setShowLargeInput(!showLargeInput)} className="p-2 text-slate-400 hover:text-blue-500 hover:bg-blue-50 rounded-xl transition-colors shrink-0">
                                <Icon n={showLargeInput ? "Minimize" : "Maximize"} s={20}/>
                            </button>
                        </div>
                    </div>
                </div>
            )}

            {/* Combined Edit Modal */}
            {modal && editItem && <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[100] flex items-end sm:items-center justify-center animate-fade-in">
                <div className="bg-white w-full sm:w-[95%] max-w-lg rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col max-h-[95vh]">
                    <div className={`px-6 py-5 border-b flex justify-between items-center rounded-t-3xl ${editItem.type==='memo'?'bg-yellow-50':'bg-slate-50'}`}>
                        <h2 className={`font-bold text-2xl font-rounded ${editItem.type==='memo'?'text-yellow-600':'text-slate-800'}`}>
                            {editItem.id && data.some(d=>d.items && d.items.some(i=>i && i.id===editItem.id)) ? (editItem.type==='memo'?'Á∑®ËºØ‰æøÊ¢ù':'Á∑®ËºØË°åÁ®ã') : (editItem.type==='memo'?'Êñ∞Â¢û‰æøÊ¢ù':'Êñ∞Â¢ûË°åÁ®ã')}
                        </h2>
                        <button onClick={()=>setModal(false)} className="p-3 bg-white rounded-full text-slate-500 hover:bg-slate-100 transition-colors shadow-sm"><Icon n="X" s={28}/></button>
                    </div>
                    
                    <div className="p-6 overflow-y-auto space-y-6" onPaste={(e)=>handlePaste(e, false)}>
                        
                        {editItem.type === 'memo' ? (
                            <>
                                 <input type="text" value={editItem.title} onChange={e=>setEditItem({...editItem,title:e.target.value})} className="w-full h-[60px] bg-white border-2 border-yellow-200 rounded-2xl px-4 font-bold text-2xl outline-none focus:border-yellow-400 transition-colors placeholder:text-slate-300" placeholder="‰æøÊ¢ùÊ®ôÈ°å..."/>
                                <textarea value={editItem.note} onChange={e=>setEditItem({...editItem,note:e.target.value})} placeholder="Ëº∏ÂÖ•Ë©≥Á¥∞ÂÖßÂÆπ... (ÊîØÊè¥Áõ¥Êé•Ë≤º‰∏äÂúñÁâá)" className="w-full bg-yellow-50 p-4 rounded-2xl text-base border-2 border-yellow-100 outline-none focus:border-yellow-400 h-40"/>
                                 
                                <div>
                                    <div className="text-sm font-bold text-slate-500 mb-2">ÂúñÁâá (‰∏äÂÇ≥/Ë≤ºÈÄ£Áµê)</div>
                                     <div className="flex gap-2 mb-2">
                                        <input ref={urlInputRef} type="text" placeholder="Ë≤º‰∏äÂúñÁâáÁ∂≤ÂùÄ..." className="flex-1 bg-white px-3 py-2 rounded-xl text-sm border border-slate-200 outline-none focus:border-yellow-400"/>
                                         <button onClick={()=>handleAddUrl(false)} className="bg-yellow-100 text-yellow-600 p-2.5 rounded-xl border border-yellow-200 active:scale-95 flex items-center justify-center"><Icon n="Plus" s={20}/></button>
                                        
                                         <button onClick={()=>imgInputRef.current.click()} className="bg-slate-200 text-slate-600 px-3 py-2 rounded-xl text-sm font-bold active:scale-95 flex items-center gap-1"><Icon n="Image" s={18}/></button>
                                        <input type="file" ref={imgInputRef} className="hidden" accept="image/*" onChange={(e)=>handleImageUpload(e, false)}/>
                                    </div>
                                    <div className="grid grid-cols-3 gap-2">
                                        {(editItem.images || []).map((imgItem, i) => {
                                            const imgSrc = typeof imgItem === 'string' ? imgItem : imgItem.url;
                                             return (
                                                <div key={i} className="relative aspect-square rounded-xl overflow-hidden border-2 border-slate-200 bg-white group shadow-sm">
                                                     <img src={imgSrc} onClick={()=>setViewImgIdx(i)} className="w-full h-full object-cover cursor-zoom-in"/>
                                                    <div className="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col justify-between p-1 z-20 pointer-events-none">
                                                         <button onClick={(e)=>{e.stopPropagation(); setEditItem({...editItem, images: editItem.images.filter((_, idx)=>idx!==i)})}} className="self-end text-white bg-red-500/80 rounded-full p-1 hover:bg-red-600 pointer-events-auto"><Icon n="X" s={14}/></button>
                                                         <div className="flex justify-between w-full pointer-events-auto">
                                                            {i > 0 && <button onClick={(e)=>moveImg(e, i, -1, false)} className="text-white bg-slate-500/80 rounded-full p-1 hover:bg-slate-600"><Icon n="ChevronLeft" s={14}/></button>}
                                                            {i < editItem.images.length - 1 && <button onClick={(e)=>moveImg(e, i, 1, false)} className="text-white bg-slate-500/80 rounded-full p-1 ml-auto hover:bg-slate-600"><Icon n="ChevronRight" s={14}/></button>}
                                                         </div>
                                                    </div>
                                                 </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </>
                        ) : (
                            /* Ë°åÁ®ãÂ∞àÂ±¨ÔºöÂàÜÈ°û„ÄÅÊ∂àË≤ª„ÄÅÂÇôË®ª„ÄÅÂÆö‰Ωç */
                            <>
                                {/* ÂÑ™ÂåñÂæåÁöÑÊó•ÊúüËàáÊôÇÈñìÈÅ∏ÊìáÂô® */}
                                <div className="flex gap-4 mb-5">
                                    <div className="flex-[3]">
                                        <label className="text-xs font-bold text-slate-500 block mb-1.5 ml-1">Êó•Êúü</label>
                                        <div className="bg-slate-50 p-1.5 rounded-2xl border border-slate-200 h-[64px] flex items-center relative transition-all hover:border-slate-300">
                                            <Icon n="Calendar" s={20} c="absolute left-3 text-slate-400 pointer-events-none"/>
                                            <select value={editItem.dayId} onChange={e=>setEditItem({...editItem, dayId: e.target.value})} className="w-full bg-transparent pl-10 pr-3 font-bold text-slate-700 outline-none text-lg h-full appearance-none">
                                                 {data.map((d, i) => d ? (
                                                    <option key={d.id} value={d.id}>D{i+1} ({d.date})</option>
                                                ) : null)}
                                             </select>
                                             <Icon n="ArrowDown" s={16} c="absolute right-3 text-slate-300 pointer-events-none"/>
                                        </div>
                                    </div>
                                    {editItem.type === 'normal' && (
                                        <div className="flex-[2] min-w-[130px]">
                                            <label className="text-xs font-bold text-slate-500 block mb-1.5 ml-1">ÊôÇÈñì</label>
                                            <TimeScroll val={editItem.time} setVal={(v)=>setEditItem({...editItem,time:v})}/>
                                        </div>
                                    )}
                                </div>

                                {/* ÂÑ™ÂåñÂæåÁöÑÊ®ôÈ°åËº∏ÂÖ•Ê°Ü */}
                                {editItem.type === 'normal' && (
                                    <div className="mb-5">
                                        <label className="text-xs font-bold text-slate-500 block mb-1.5 ml-1">Ê®ôÈ°å</label>
                                        <textarea 
                                            value={editItem.title} 
                                            onChange={e=>setEditItem({...editItem,title:e.target.value})} 
                                            className="w-full h-36 bg-white border-2 border-slate-200 rounded-2xl p-4 font-bold text-2xl outline-none focus:border-blue-400 transition-colors placeholder:text-slate-300 resize-none leading-relaxed shadow-sm focus:shadow-md" 
                                            placeholder="Ëº∏ÂÖ•Ë°åÁ®ãÊ®ôÈ°å..."
                                        />
                                    </div>
                                )}

                                <div>
                                    <label className="text-base font-bold text-slate-500 mb-2 block ml-1">ÂàÜÈ°û</label>
                                    <div className="grid grid-cols-6 gap-1.5">
                                         {Object.entries(CATS).filter(([k])=>k!=='memo').map(([k, v]) => (
                                            <button key={k} onClick={()=>setEditItem({...editItem, category:k})} className={`h-16 rounded-xl font-bold border-2 transition-all flex flex-col items-center justify-center gap-0.5 ${editItem.category===k ? 'bg-blue-500 text-white border-blue-500 shadow-md scale-105 z-10' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>
                                                <Icon n={v.i} s={22}/> <span className="text-[10px]">{v.l}</span>
                                            </button>
                                         ))}
                                    </div>
                                </div>
                                
                                <div className="bg-slate-50 rounded-2xl p-4 border border-slate-100 mt-5"><div className="flex justify-between items-center mb-3"><label className="text-sm font-bold text-slate-500">Ê∂àË≤ªÊòéÁ¥∞</label><button onClick={addExpense} className="text-xs bg-blue-100 text-blue-600 px-3 py-1.5 rounded-full font-bold hover:bg-blue-200 transition-colors">+ Êñ∞Â¢û</button></div>{(!editItem.expenses || editItem.expenses.length === 0) && <div className="text-center text-slate-400 text-sm py-2">Â∞öÁÑ°Ê∂àË≤ªÁ¥ÄÈåÑ</div>}<div className="space-y-2">{(editItem.expenses || []).map((ex, idx) => (<div key={ex.id} className="flex gap-2 items-center flex-wrap sm:flex-nowrap bg-white p-2 rounded-xl border border-slate-100 shadow-sm"><div className="w-full sm:w-auto flex-1 min-w-0"><input type="text" placeholder="È†ÖÁõÆ" value={ex.label} onChange={e => updateExpense(idx, 'label', e.target.value)} className="w-full text-sm font-bold outline-none bg-transparent placeholder:text-slate-300" /></div><div className="flex items-center gap-2 w-full sm:w-auto justify-end mt-2 sm:mt-0"><select value={ex.category || 'other'} onChange={e => updateExpense(idx, 'category', e.target.value)} className="text-xs bg-slate-100 rounded-lg px-2 py-1 outline-none border-0 text-slate-600 max-w-[80px]">{Object.entries(CATS).filter(([k])=>k!=='memo').map(([k,v])=><option key={k} value={k}>{v.l}</option>)}</select><div className="flex items-center bg-slate-50 rounded-lg px-2 py-1"><select value={ex.currency} onChange={e => updateExpense(idx, 'currency', e.target.value)} className="bg-transparent text-xs font-bold outline-none text-slate-500 mr-1"><option value="JPY">¬•</option><option value="NT">NT</option></select><input type="number" placeholder="0" value={ex.amount} onChange={e => updateExpense(idx, 'amount', e.target.value)} className="w-24 text-sm font-mono font-bold outline-none bg-transparent text-right" /></div><button onClick={() => removeExpense(idx)} className="text-slate-300 hover:text-red-500 transition-colors"><Icon n="X" s={16}/></button></div></div>))}</div><div className="mt-3 flex justify-end gap-4 text-sm font-bold text-slate-600 border-t border-slate-200 pt-2"><span>¬• {fmtMoney((editItem.expenses||[]).filter(e=>e.currency!=='NT').reduce((s,x)=>s+Number(x.amount||0),0))}</span><span>NT {fmtMoney((editItem.expenses||[]).filter(e=>e.currency==='NT').reduce((s,x)=>s+Number(x.amount||0),0))}</span></div></div>
                                
                                <div className="space-y-2 mt-4"><label className="text-sm font-bold text-slate-500 flex items-center gap-1"><Icon n="Footprints" s={16} c="text-blue-500"/> Ê≠•Êï∏ (ÈÅ∏Â°´)</label><input type="number" value={editItem.steps||''} onChange={e=>setEditItem({...editItem,steps:e.target.value})} placeholder="‰æãÂ¶Ç: 5000" className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-3 font-mono text-base outline-none focus:border-blue-400"/></div>
                                
                                <div className="space-y-2 mt-4"><label className="text-sm font-bold text-slate-500">ÂÇôË®ª</label><textarea value={editItem.note} onChange={e=>setEditItem({...editItem,note:e.target.value})} placeholder="Ëº∏ÂÖ•ÂÇôË®ª..." className="w-full bg-slate-50 border-2 border-slate-100 rounded-2xl p-3 text-base h-24 outline-none focus:border-blue-400"/></div>
                
                                <div className="bg-slate-50 p-4 rounded-2xl mb-4 border border-slate-100 mt-4"><div className="space-y-3"><div><label className="text-xs text-slate-400 block mb-1">ËªäËºâÂ∞éËà™ Mapcode</label><div className="flex gap-2"><input type="text" value={editItem.mapcode} onChange={e=>setEditItem({...editItem,mapcode:e.target.value})} placeholder="Mapcode" className="flex-1 bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-400 font-mono"/><a href="https://japanmapcode.com/zh-TW" target="_blank" rel="noopener noreferrer" className="p-3 bg-white text-slate-500 border border-slate-200 rounded-2xl hover:bg-slate-50 active:scale-95 flex items-center justify-center"><Icon n="Globe" s={20}/></a></div></div><div><label className="text-xs text-slate-400 block mb-1">Google Maps ÊêúÂ∞ãÈóúÈçµÂ≠ó</label><div className="flex gap-2"><input type="text" value={editItem.searchKeyword} onChange={e=>setEditItem({...editItem,searchKeyword:e.target.value})} placeholder="‰æãÂ¶Ç: Êô¥Á©∫Â°î" className="flex-1 bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm outline-none focus:border-blue-400"/><a href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(editItem.searchKeyword||editItem.title)}`} target="_blank" className="p-3 bg-white text-slate-500 border border-slate-200 rounded-2xl hover:bg-slate-50 active:scale-95 flex items-center justify-center"><Icon n="Search" s={20}/></a></div></div></div></div>
                            </>
                        )}
                    </div>
                    
                    <div className="p-5 border-t flex gap-4 bg-white pb-safe">
                        <button onClick={delItem} className="p-4 rounded-2xl bg-red-50 text-red-500 border-2 border-red-100 hover:bg-red-100 transition-colors"><Icon n="Trash2" s={24}/></button>
                         <button onClick={saveItem} className={`flex-1 text-white rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition-transform py-4 flex justify-center items-center gap-2 ${editItem.type==='memo'?'bg-yellow-500 shadow-yellow-200':'bg-gradient-to-r from-blue-500 to-blue-600 shadow-blue-200'}`}><Icon n="Save" s={20}/> ÂÑ≤Â≠ò</button>
                    </div>
                </div>
            </div>}
            
            {stepModal && <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center px-4 animate-fade-in" onClick={(e) => e.target === e.currentTarget && setStepModal(false)}>
                <div className="bg-white w-full max-w-xs rounded-3xl shadow-2xl p-6 card-shadow relative overflow-hidden">
                    <div className="absolute -top-10 -right-10 w-32 h-32 bg-pink-100 rounded-full opacity-50 pointer-events-none"></div>
                    <div className="flex justify-between items-center mb-6 relative z-10">
                        <h3 className="font-black text-2xl text-slate-800 flex items-center gap-2"><span className="text-pink-500"><Icon n="Footprints" s={32}/></span>‰ªäÊó•ÈÅãÂãï</h3>
                        <button onClick={()=>setStepModal(false)} className="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-full text-slate-400 hover:bg-rose-100 hover:text-rose-500 transition-colors"><Icon n="X" s={24}/></button>
                    </div>
                     
                    <div className="bg-gradient-to-br from-pink-50 to-rose-50 rounded-2xl p-5 mb-5 text-center border border-pink-100 relative z-10">
                        <div className="text-sm text-slate-500 font-bold mb-1 tracking-wide uppercase">Ë°åÁ®ãÈ†ê‰º∞Ê≠•Êï∏</div>
                        <div className="text-3xl font-black text-slate-400 font-mono tracking-tight opacity-80">{planSteps.toLocaleString()}</div>
                    </div>

                    <div className="space-y-3 mb-6 relative z-10">
                        <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                             <div className="flex items-center gap-2 text-slate-500 font-bold text-sm"><Icon n="Map" s={18}/> Ë∑ùÈõ¢</div>
                            <div className="font-mono font-bold text-slate-700 text-lg">‚âà {((Number(tStep) || 0) * 0.0007).toFixed(1)} <span className="text-xs font-normal text-slate-400">km</span></div>
                        </div>
                        <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                            <div className="flex items-center gap-2 text-orange-500 font-bold text-sm"><Icon n="Fire" s={18}/> ÁÜ±Èáè</div>
                             <div className="font-mono font-bold text-slate-700 text-lg">‚âà {Math.round((Number(tStep) || 0) * 0.04)} <span className="text-xs font-normal text-slate-400">kcal</span></div>
                        </div>
                        <div className="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100">
                             <div className="flex items-center gap-2 text-slate-500 font-bold text-sm">üçô È£ØÁ≥∞</div>
                             <div className="font-mono font-bold text-slate-700 text-lg">‚âà {(Math.round((Number(tStep) || 0) * 0.04) / 200).toFixed(1)} <span className="text-xs font-normal text-slate-400">ÂÄã</span></div>
                        </div>
                     </div>

                    <div className="mb-2 text-sm font-bold text-rose-500 ml-1 relative z-10">Á¥ÄÈåÑÂØ¶ÈöõÊ≠•Êï∏</div>
                    <input ref={stepRef} type="number" value={tStep} onChange={e=>setTStep(e.target.value)} className="w-full bg-white border-2 border-pink-200 rounded-2xl p-4 text-center font-bold font-mono text-3xl outline-none focus:border-pink-400 text-rose-500 placeholder:text-slate-200 mb-4 shadow-sm relative z-10 transition-all focus:shadow-md focus:-translate-y-0.5" placeholder="0"/>
                     
                    <button onClick={saveStep} className="w-full bg-gradient-to-r from-pink-500 to-rose-500 text-white rounded-2xl py-4 font-bold text-lg shadow-lg shadow-pink-200 active:scale-95 transition-transform relative z-10">{saveBtnText}</button>
                </div>
            </div>}
        </div>
    );
}
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>